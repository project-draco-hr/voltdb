{
  TreeMap<Long,Snapshot> snapshots=new TreeMap<Long,SnapshotUtil.Snapshot>();
  if (m_action == START_ACTION.RECOVER || m_action == START_ACTION.START) {
    snapshots=getSnapshots();
  }
  final Long maxLastSeenTxn=m_replayAgent.getMaxLastSeenTxn();
  Set<SnapshotInfo> snapshotInfos=new HashSet<SnapshotInfo>();
  for (  Entry<Long,Snapshot> e : snapshots.entrySet()) {
    if (maxLastSeenTxn != null && e.getKey() < maxLastSeenTxn) {
      continue;
    }
    SnapshotInfo info=checkSnapshotIsComplete(e.getKey(),e.getValue());
    if (info != null) {
      snapshotInfos.add(info);
    }
  }
  LOG.debug("Gathered " + snapshotInfos.size() + " snapshot information");
  sendLocalRestoreInformation(maxLastSeenTxn,snapshotInfos);
  Set<SnapshotInfo> lastSnapshot=getRestorePlan();
  SnapshotInfo infoWithMinHostId=pickSnapshotInfo(lastSnapshot);
  if (m_action == START_ACTION.RECOVER || m_action == START_ACTION.START) {
    m_replayAgent.generateReplayPlan();
  }
  m_planned=true;
  return infoWithMinHostId;
}
