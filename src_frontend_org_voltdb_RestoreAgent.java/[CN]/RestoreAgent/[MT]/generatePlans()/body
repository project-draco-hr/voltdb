{
  TreeMap<Long,Snapshot> snapshots=new TreeMap<Long,SnapshotUtil.Snapshot>();
  if (m_action == START_ACTION.RECOVER || m_action == START_ACTION.START) {
    snapshots=getSnapshots();
  }
  final Long maxLastSeenTxn=m_replayAgent.getMaxLastSeenTxn();
  Set<SnapshotInfo> snapshotInfos=new HashSet<SnapshotInfo>();
  for (  Entry<Long,Snapshot> e : snapshots.entrySet()) {
    if (!VoltDB.instance().isIV2Enabled()) {
      if (maxLastSeenTxn != null && e.getKey() < maxLastSeenTxn) {
        continue;
      }
    }
    SnapshotInfo info=checkSnapshotIsComplete(e.getKey(),e.getValue());
    if (m_replayAgent.getInstanceId() != null && !m_replayAgent.getInstanceId().equals(info.instanceId)) {
      continue;
    }
    if (VoltDB.instance().isIV2Enabled()) {
      final Map<Integer,Long> cmdlogmap=m_replayAgent.getMaxLastSeenTxnByPartition();
      final Map<Integer,Long> snapmap=info.partitionToTxnId;
      if (cmdlogmap != null) {
        if (snapmap == null || cmdlogmap.size() != snapmap.size()) {
          info=null;
        }
 else {
          for (          Integer cmdpart : cmdlogmap.keySet()) {
            Long snaptxnId=snapmap.get(cmdpart);
            if (snaptxnId == null) {
              info=null;
              break;
            }
 else             if (snaptxnId < cmdlogmap.get(cmdpart)) {
              info=null;
              break;
            }
          }
        }
      }
    }
    if (info != null) {
      snapshotInfos.add(info);
    }
  }
  LOG.debug("Gathered " + snapshotInfos.size() + " snapshot information");
  sendLocalRestoreInformation(maxLastSeenTxn,snapshotInfos);
  Set<SnapshotInfo> lastSnapshot=getRestorePlan();
  SnapshotInfo infoWithMinHostId=consolidateSnapshotInfos(lastSnapshot);
  if (m_action == START_ACTION.RECOVER || m_action == START_ACTION.START) {
    m_replayAgent.generateReplayPlan();
  }
  m_planned=true;
  return infoWithMinHostId;
}
