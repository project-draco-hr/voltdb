{
  int size=1 + 1 + 4;
  if (max != null) {
    size+=8;
  }
  for (  SnapshotInfo i : snapshots) {
    size+=i.size();
  }
  ByteBuffer buf=ByteBuffer.allocate(size);
  if (max == null) {
    buf.put((byte)0);
  }
 else {
    buf.put((byte)1);
    buf.putLong(max);
  }
  buf.put((byte)m_action.ordinal());
  buf.putInt(snapshots.size());
  for (  SnapshotInfo snapshot : snapshots) {
    buf.putLong(snapshot.txnId);
    buf.putLong(snapshot.catalogCrc);
    buf.putInt(snapshot.nonce.length());
    buf.put(snapshot.nonce.getBytes());
    buf.putInt(snapshot.path.length());
    buf.put(snapshot.path.getBytes());
    buf.putInt(snapshot.partitionCount);
    buf.putInt(snapshot.partitions.size());
    for (    Entry<String,Set<Integer>> p : snapshot.partitions.entrySet()) {
      buf.putInt(p.getKey().length());
      buf.put(p.getKey().getBytes());
      buf.putInt(p.getValue().size());
      for (      int id : p.getValue()) {
        buf.putInt(id);
      }
    }
  }
  return buf;
}
