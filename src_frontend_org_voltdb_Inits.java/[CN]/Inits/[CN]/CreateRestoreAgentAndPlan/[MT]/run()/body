{
  if (!m_isRejoin && !m_config.m_isRejoinTest && !m_rvdb.m_joining) {
    String snapshotPath=null;
    if (m_rvdb.m_catalogContext.cluster.getDatabases().get("database").getSnapshotschedule().get("default") != null) {
      snapshotPath=m_rvdb.m_catalogContext.cluster.getDatabases().get("database").getSnapshotschedule().get("default").getPath();
    }
    int[] allPartitions=new int[m_rvdb.m_configuredNumberOfPartitions];
    for (int ii=0; ii < allPartitions.length; ii++) {
      allPartitions[ii]=ii;
    }
    org.voltdb.catalog.CommandLog cl=m_rvdb.m_catalogContext.cluster.getLogconfig().get("log");
    try {
      m_rvdb.m_restoreAgent=new RestoreAgent(m_rvdb.m_messenger,m_rvdb.getSnapshotCompletionMonitor(),m_rvdb,m_config.m_startAction,cl.getEnabled(),cl.getLogpath(),cl.getInternalsnapshotpath(),snapshotPath,allPartitions,CatalogUtil.getVoltDbRoot(m_deployment.getPaths()).getAbsolutePath());
    }
 catch (    IOException e) {
      VoltDB.crashLocalVoltDB("Unable to construct the RestoreAgent",true,e);
    }
    m_rvdb.m_globalServiceElector.registerService(m_rvdb.m_restoreAgent);
    m_rvdb.m_restoreAgent.setCatalogContext(m_rvdb.m_catalogContext);
    Pair<Integer,String> catalog=m_rvdb.m_restoreAgent.findRestoreCatalog();
    if (catalog != null) {
      int hostId=catalog.getFirst().intValue();
      String catalogPath=catalog.getSecond();
      try {
        byte[] catalogBytes=readCatalog(catalogPath);
        InMemoryJarfile inMemoryJar=CatalogUtil.loadInMemoryJarFile(catalogBytes);
        String[] buildInfo=CatalogUtil.getBuildInfoFromJar(inMemoryJar);
        String catalogVersion=buildInfo[0];
        String serverVersion=m_rvdb.getVersionString();
        if (!catalogVersion.equals(serverVersion)) {
          VoltDB.crashLocalVoltDB(String.format("Unable to load version %s catalog \"%s\" " + "from snapshot into a version %s server.",catalogVersion,catalogPath,serverVersion),false,null);
        }
      }
 catch (      IOException e) {
        VoltDB.crashLocalVoltDB("Unable to load catalog for version check.",false,e);
      }
      hostLog.debug("Found catalog to load on host " + hostId + ": "+ catalogPath);
      m_rvdb.m_hostIdWithStartupCatalog=hostId;
      assert(m_rvdb.m_hostIdWithStartupCatalog >= 0);
      m_rvdb.m_pathToStartupCatalog=catalogPath;
      assert(m_rvdb.m_pathToStartupCatalog != null);
    }
  }
}
