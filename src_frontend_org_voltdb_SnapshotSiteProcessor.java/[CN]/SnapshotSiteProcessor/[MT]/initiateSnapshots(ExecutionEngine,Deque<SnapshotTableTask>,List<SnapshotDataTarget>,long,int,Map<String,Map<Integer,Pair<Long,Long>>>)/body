{
  ExecutionSitesCurrentlySnapshotting.add(this);
  final long now=System.currentTimeMillis();
  m_quietUntil=now + 200;
  m_lastSnapshotSucceded=true;
  m_lastSnapshotTxnId=txnId;
  m_lastSnapshotNumHosts=numHosts;
  m_snapshotTableTasks=MiscUtils.sortedArrayListMultimap();
  m_snapshotTargets=new ArrayList<SnapshotDataTarget>();
  m_snapshotTargetTerminators=new ArrayList<Thread>();
  m_exportSequenceNumbersToLogOnCompletion=exportSequenceNumbers;
  for (  final SnapshotDataTarget target : targets) {
    if (target.needsFinalClose()) {
      assert(m_snapshotTargets != null);
      m_snapshotTargets.add(target);
    }
  }
  Map<Integer,Pair<Table,SnapshotPredicates>> tablesAndPredicates=makeTablesAndPredicatesToSnapshot(tasks);
  activateTableStreams(ee,tablesAndPredicates);
  int maxTableTaskSize=0;
  for (  Collection<SnapshotTableTask> perTableTasks : m_snapshotTableTasks.asMap().values()) {
    maxTableTaskSize=Math.max(maxTableTaskSize,perTableTasks.size());
  }
  resizeBufferPool(maxTableTaskSize * m_bufferCountMultiplier);
  if (m_isIV2Enabled) {
    for (int ii=0; ii < m_availableSnapshotBuffers.size(); ii++) {
      VoltDB.instance().schedulePriorityWork(new Runnable(){
        @Override public void run(){
          m_siteTaskerQueue.offer(new SnapshotTask());
        }
      }
,(m_quietUntil + (5 * m_snapshotPriority) - now),0,TimeUnit.MILLISECONDS);
      m_quietUntil+=5 * m_snapshotPriority;
    }
  }
}
