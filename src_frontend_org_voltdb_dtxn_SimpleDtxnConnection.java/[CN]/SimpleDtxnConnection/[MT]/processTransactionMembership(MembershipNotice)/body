{
  if (notice.getTxnId() <= m_lastCompletedTxnId) {
    if (notice instanceof FragmentTask) {
      return null;
    }
    StringBuilder msg=new StringBuilder();
    msg.append("Txn ordering deadlock (DTXN) at site ").append(m_siteId).append(":\n");
    msg.append("   txn ").append(m_lastCompletedTxnId).append(" (");
    msg.append(TransactionIdManager.toString(m_lastCompletedTxnId)).append(" HB: ?");
    msg.append(") before\n");
    msg.append("   txn ").append(notice.getTxnId()).append(" (");
    msg.append(TransactionIdManager.toString(notice.getTxnId())).append(" HB:");
    msg.append(notice.isHeartBeat()).append(").\n");
    throw new RuntimeException(msg.toString());
  }
  m_transactionQueue.gotTransaction(notice.getInitiatorSiteId(),notice.getTxnId(),notice.isHeartBeat());
  if (notice.isHeartBeat())   return null;
  if ((m_current != null) && (m_current.txnId == notice.getTxnId()))   return m_current;
  TransactionState state=m_transactionsById.get(notice.getTxnId());
  if (state == null) {
    if (notice instanceof InitiateTask) {
      InitiateTask it=(InitiateTask)notice;
      if (it.isSinglePartition())       state=new SinglePartitionTxnState(m_mailbox,this,m_site,it);
 else       state=new MultiPartitionParticipantTxnState(m_mailbox,this,m_site,it);
    }
 else {
      state=new MultiPartitionParticipantTxnState(m_mailbox,this,m_site,notice);
    }
    m_transactionQueue.add(state);
    m_transactionsById.put(state.txnId,state);
  }
  return state;
}
