{
  try {
    internalProcessResults(rc,path,ctx,data,stat);
    if (Code.get(rc) != Code.OK) {
      return;
    }
    int[] stamp=new int[]{0};
    OperationMode prev=m_mode.get(stamp);
    if (stamp[0] > stat.getVersion()) {
      return;
    }
    OperationMode next=data != null ? OperationMode.valueOf(data) : OperationMode.RUNNING;
    if (!m_mode.compareAndSet(prev,next,stamp[0],stat.getVersion())) {
      return;
    }
    mode=Optional.of(new VersionedOperationMode(next,stat.getVersion()));
    if (m_isLeader && !m_done.get() && next == OperationMode.RUNNING) {
      m_es.submit(new AssignChannels());
    }
    m_eb.post(mode.get());
  }
  finally {
    lock.release();
  }
}
