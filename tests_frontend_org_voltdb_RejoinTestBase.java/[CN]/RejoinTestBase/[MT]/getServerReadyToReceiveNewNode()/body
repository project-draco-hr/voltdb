{
  Context retval=new Context();
  VoltProjectBuilder builder=getBuilderForTest();
  boolean success=builder.compile(Configuration.getPathToCatalogForTest("rejoin.jar"),1,2,1,"localhost",9998,false);
  assertTrue(success);
  MiscUtils.copyFile(builder.getPathToDeployment(),Configuration.getPathToCatalogForTest("rejoin.xml"));
  VoltDB.Configuration config=new VoltDB.Configuration();
  config.m_pathToCatalog=Configuration.getPathToCatalogForTest("rejoin.jar");
  config.m_pathToDeployment=Configuration.getPathToCatalogForTest("rejoin.xml");
  config.m_adminPort=9998;
  config.m_isRejoinTest=true;
  retval.localServer=new ServerThread(config);
  long deploymentCRC=CatalogUtil.getDeploymentCRC(builder.getPathToDeployment());
  InMemoryJarfile jarFile=new InMemoryJarfile(Configuration.getPathToCatalogForTest("rejoin.jar"));
  retval.catalogCRC=jarFile.getCRC();
  VoltNetwork network2=new VoltNetwork();
  InetAddress leader=InetAddress.getByName("localhost");
  HostMessenger host2=new HostMessenger(network2,leader,2,0,deploymentCRC,null);
  retval.localServer.start();
  host2.waitForGroupJoin();
  if (host2.getHostId() == 0)   host2.sendCatalog(jarFile.getFullJarBytes());
  network2.start();
  int myHostId=host2.getHostId() * 100;
  host2.createLocalSite(myHostId);
  Mailbox mailbox=host2.createMailbox(myHostId,VoltDB.AGREEMENT_MAILBOX_ID,false);
  AgreementSite site=new AgreementSite(myHostId,new HashSet<Integer>(Arrays.asList(0,100)),myHostId == 0 ? 1 : 2,new HashSet<Integer>(),mailbox,new InetSocketAddress(2182),null,false);
  site.start();
  host2.sendReadyMessage();
  retval.localServer.waitForInitialization();
  HostMessenger host1=VoltDB.instance().getHostMessenger();
  site.shutdown();
  host2.closeForeignHostSocket(host1.getHostId());
  Thread.sleep(50);
  host2.shutdown();
  Thread.sleep(50);
  for (int i=0; host1.countForeignHosts() > 0; i++) {
    if (i > 10)     fail();
    Thread.sleep(50);
  }
  assertEquals(0,host1.countForeignHosts());
  return retval;
}
