{
  if (!m_sentInitiate) {
    m_sentInitiate=true;
    sendInitiateMessage(txnId);
  }
  if (txnId < m_stopBeforeTxnId) {
    return;
  }
  recoveryLog.trace("Starting recovery before txnid " + txnId + " for site "+ m_siteId+ " from "+ m_sourceSiteId);
  m_recoveryBegan=true;
  for (  RecoveryMessage rm : m_buffered) {
    handleRecoveryMessage(rm);
  }
  m_buffered.clear();
  while (true) {
    VoltMessage message=m_mailbox.recv();
    if (message != null) {
      if (message instanceof RecoveryMessage) {
        handleRecoveryMessage((RecoveryMessage)message);
      }
 else {
        m_messageHandler.handleMessage(message);
      }
    }
 else {
      Thread.yield();
    }
    if (m_tables.isEmpty()) {
      recoveryLog.info("Processor spent " + (m_timeSpentHandlingData / 1000.0) + " seconds handling data");
      m_onCompletion.run();
      return;
    }
  }
}
