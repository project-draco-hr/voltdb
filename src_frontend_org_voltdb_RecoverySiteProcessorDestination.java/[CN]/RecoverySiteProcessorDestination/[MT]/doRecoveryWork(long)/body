{
  if (!m_sentInitiate) {
    m_sentInitiate=true;
    try {
      sendInitiateMessage(txnId);
    }
 catch (    IOException e) {
      VoltDB.crashLocalVoltDB("Error sending initiate message",true,e);
    }
  }
  if (m_skipPastTxnId != null) {
    if (m_skipPastTxnId >= txnId) {
      return;
    }
 else {
      m_skipPastTxnId=null;
      try {
        processNextInitiateResponse(txnId);
      }
 catch (      IOException e) {
        VoltDB.crashLocalVoltDB("Error process a second initiate response",true,e);
      }
    }
  }
  if (txnId < m_stopBeforeTxnId) {
    return;
  }
  recoveryLog.info("Starting recovery before txnid " + txnId + " for site "+ m_siteId+ " from "+ m_sourceSiteId);
  while (true) {
    BBContainer container=null;
    while ((container=m_incoming.poll()) != null) {
      try {
        handleRecoveryMessage(container.b,container.address);
      }
  finally {
        container.discard();
      }
    }
    if (m_tables.isEmpty()) {
synchronized (this) {
        m_recoveryComplete=true;
        BBContainer buffer=null;
        while ((buffer=m_buffers.poll()) != null) {
          m_bufferToOriginMap.remove(buffer).discard();
        }
      }
      recoveryLog.info("Processor spent " + (m_timeSpentHandlingData / 1000.0) + " seconds handling data");
      m_onCompletion.run();
      m_iodaemon.close();
      return;
    }
    if (!checkMailbox(false,txnId)) {
      Thread.yield();
    }
  }
}
