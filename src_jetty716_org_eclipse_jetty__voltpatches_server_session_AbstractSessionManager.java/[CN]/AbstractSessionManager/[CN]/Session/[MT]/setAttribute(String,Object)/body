{
  Object old_value;
  if (value == null) {
    removeAttribute(name);
    return;
  }
synchronized (this) {
    if (_invalid)     throw new IllegalStateException();
    if (_values == null)     _values=newAttributeMap();
    old_value=_values.put(name,value);
  }
  if (old_value == null || !value.equals(old_value)) {
    unbindValue(name,old_value);
    bindValue(name,value);
    if (_sessionAttributeListeners != null) {
      HttpSessionBindingEvent event=new HttpSessionBindingEvent(this,name,old_value == null ? value : old_value);
      for (int i=0; i < LazyList.size(_sessionAttributeListeners); i++) {
        HttpSessionAttributeListener l=(HttpSessionAttributeListener)LazyList.get(_sessionAttributeListeners,i);
        if (old_value == null)         l.attributeAdded(event);
 else         l.attributeReplaced(event);
      }
    }
  }
}
