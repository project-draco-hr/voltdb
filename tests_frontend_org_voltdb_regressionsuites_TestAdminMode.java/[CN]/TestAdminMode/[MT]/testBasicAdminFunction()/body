{
  final Client client=ClientFactory.createClient();
  final Client adminclient=ClientFactory.createClient();
  try {
    client.createConnection("localhost");
    adminclient.createConnection("localhost",32323);
    boolean admin_start=false;
    try {
      client.callProcedure("InsertA",0,1000);
    }
 catch (    ProcCallException e) {
      assertEquals("Server did not report itself as unavailable on production port",ClientResponse.SERVER_UNAVAILABLE,e.getClientResponse().getStatus());
      admin_start=true;
    }
    assertTrue("Server did not report itself as unavailable on production port",admin_start);
    VoltTable[] results=adminclient.callProcedure("CountA").getResults();
    assertEquals(0,results[0].asScalarLong());
    for (int i=0; i < 100; i++) {
      adminclient.callProcedure("InsertA",i,1000 + i);
    }
    adminclient.drain();
    results=adminclient.callProcedure("CountA").getResults();
    assertEquals(100,results[0].asScalarLong());
    adminclient.callProcedure("@AdminModeExit");
    results=client.callProcedure("CountA").getResults();
    assertEquals(100,results[0].asScalarLong());
    results=adminclient.callProcedure("CountA").getResults();
    assertEquals(100,results[0].asScalarLong());
    boolean admin_failed=false;
    try {
      client.callProcedure("@AdminModeEnter");
    }
 catch (    ProcCallException e) {
      admin_failed=true;
      assertTrue("Server returned an unexpected error",e.getClientResponse().getStatusString().contains("is not available to this client"));
    }
    assertTrue("Server allowed admin mode sysproc on production port",admin_failed);
    admin_failed=false;
    try {
      client.callProcedure("@AdminModeExit");
    }
 catch (    ProcCallException e) {
      admin_failed=true;
      assertTrue("Server returned an unexpected error",e.getClientResponse().getStatusString().contains("is not available to this client"));
    }
    assertTrue("Server allowed admin mode sysproc on production port",admin_failed);
    adminclient.callProcedure("@AdminModeEnter");
    boolean admin_reentered=false;
    try {
      client.callProcedure("InsertA",0,1000);
    }
 catch (    ProcCallException e) {
      assertEquals("Server did not report itself as unavailable on production port",ClientResponse.SERVER_UNAVAILABLE,e.getClientResponse().getStatus());
      admin_reentered=true;
    }
    assertTrue("Server did not report itself as unavailable on production port",admin_reentered);
    results=adminclient.callProcedure("CountA").getResults();
    assertEquals(100,results[0].asScalarLong());
  }
  finally {
    adminclient.close();
    client.close();
  }
}
