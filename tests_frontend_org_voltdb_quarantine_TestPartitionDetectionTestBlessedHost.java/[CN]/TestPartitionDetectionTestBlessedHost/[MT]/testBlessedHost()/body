{
  final Semaphore rateLimit=new Semaphore(10);
  Client client=ClientFactory.createClient();
  VoltProjectBuilder builder=getBuilderForTest();
  LocalCluster cluster=new LocalCluster("partition-detection2.jar",2,2,1,BackendTarget.NATIVE_EE_JNI);
  cluster.setHasLocalServer(false);
  boolean success=cluster.compileWithPartitionDetection(builder,TMPDIR,TESTNONCE);
  assertTrue(success);
  cluster.startUp();
  client.createConnection("localhost",cluster.port(0));
  for (int i=0; i < 100; i++) {
    rateLimit.acquire();
    client.callProcedure(new Callback(rateLimit),"InsertA",i,1000 + i);
  }
  client.drain();
  client.close();
  int blessed=cluster.getBlessedPartitionDetectionProcId();
  if (blessed == 0) {
    cluster.shutDownSingleHost(1);
  }
 else {
    cluster.shutDownSingleHost(0);
  }
  client=ClientFactory.createClient();
  client.createConnection("localhost",cluster.port(blessed));
  for (int i=100; i < 200; i++) {
    rateLimit.acquire();
    client.callProcedure(new Callback(rateLimit),"InsertA",i,1000 + i);
  }
  client.drain();
  client.close();
  assertTrue(CallbackGood.allOk.get());
}
