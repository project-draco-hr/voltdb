{
  int partition=getCorrespondingPartitionId();
  long sourceSite=0;
  List<Long> sourceSites=new ArrayList<Long>(m_tracker.getSitesForPartition(partition));
  TreeMap<Integer,Long> orderedSourceSites=new TreeMap<Integer,Long>();
  for (  long HSId : sourceSites) {
    orderedSourceSites.put(CoreUtils.getHostIdFromHSId(HSId),HSId);
  }
  orderedSourceSites.remove(CoreUtils.getHostIdFromHSId(getSiteId()));
  if (!orderedSourceSites.isEmpty()) {
    sourceSite=orderedSourceSites.pollFirstEntry().getValue();
  }
 else {
    VoltDB.crashLocalVoltDB("No source for partition " + partition,false,null);
  }
  String data=null;
  try {
    JSONStringer jsStringer=new JSONStringer();
    jsStringer.object();
    jsStringer.key("hsId").value(hsId);
    m_rejoinLog.info("Rejoin source for site " + CoreUtils.hsIdToString(getSiteId()) + " is "+ CoreUtils.hsIdToString(sourceSite));
    jsStringer.key("target_hsid").value(sourceSite);
    jsStringer.endObject();
    data=jsStringer.toString();
  }
 catch (  Exception e) {
    VoltDB.crashLocalVoltDB("Failed to serialize to JSON",true,e);
  }
  SnapshotResponseHandler handler=new SnapshotResponseHandler(){
    @Override public void handleResponse(    ClientResponse resp){
      if (resp == null) {
        VoltDB.crashLocalVoltDB("Failed to initiate rejoin snapshot",false,null);
      }
 else       if (resp.getStatus() != ClientResponseImpl.SUCCESS) {
        VoltDB.crashLocalVoltDB("Failed to initiate rejoin snapshot: " + resp.getStatusString(),false,null);
      }
      VoltTable[] results=resp.getResults();
      if (SnapshotUtil.didSnapshotRequestSucceed(results)) {
        if (SnapshotUtil.isSnapshotQueued(results)) {
          m_rejoinLog.debug("Rejoin snapshot queued, waiting...");
          return;
        }
        long txnId=-1;
        String appStatus=resp.getAppStatusString();
        if (appStatus == null) {
          VoltDB.crashLocalVoltDB("Rejoin snapshot request failed: " + resp.getStatusString(),false,null);
        }
        try {
          JSONObject jsObj=new JSONObject(appStatus);
          txnId=jsObj.getLong("txnId");
        }
 catch (        JSONException e) {
          VoltDB.crashLocalVoltDB("Failed to get the rejoin snapshot txnId",true,e);
          return;
        }
        m_rejoinLog.debug("Received rejoin snapshot txnId " + txnId);
        RejoinMessage msg=new RejoinMessage(txnId);
        m_mailbox.send(getSiteId(),msg);
      }
 else {
        VoltDB.crashLocalVoltDB("Snapshot request for rejoin failed",false,null);
      }
    }
  }
;
  String nonce="Rejoin_" + getSiteId() + "_"+ System.currentTimeMillis();
  SnapshotUtil.requestSnapshot(0l,"",nonce,false,SnapshotFormat.STREAM,data,handler,true);
  return null;
}
