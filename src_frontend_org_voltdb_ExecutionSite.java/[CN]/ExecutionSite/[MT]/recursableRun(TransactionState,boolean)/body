{
  while ((!shutdownAllowed) || (m_shouldContinue)) {
    boolean moreWork=(currentTxnState != null) || ((currentTxnState=m_transactionQueue.poll()) != null);
    while (moreWork) {
      assert(currentTxnState != null);
      if (currentTxnState.doWork()) {
        completeTransaction(currentTxnState.isReadOnly);
        TransactionState ts=m_transactionsById.remove(currentTxnState.txnId);
        assert(ts != null);
        moreWork=(currentTxnState=m_transactionQueue.poll()) != null;
      }
 else {
        moreWork=false;
        if (currentTxnState.shouldResumeProcedure()) {
          Map<Integer,List<VoltTable>> retval=currentTxnState.getPreviousStackFrameDropDependendencies();
          assert(retval != null);
          assert(shutdownAllowed == false);
          return retval;
        }
      }
    }
    VoltMessage message=m_mailbox.recvBlocking(5);
    tick();
    if (message != null) {
      handleMailboxMessage(message);
    }
  }
  assert(shutdownAllowed);
  return null;
}
