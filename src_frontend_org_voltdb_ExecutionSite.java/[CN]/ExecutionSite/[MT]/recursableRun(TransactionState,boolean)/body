{
  while (m_shouldContinue) {
    boolean rejoining=m_recovering && !isReplay;
    if (currentTxnState.doWork(rejoining,!isReplay)) {
      if (currentTxnState.needsRollback()) {
        rollbackTransaction(currentTxnState);
      }
      completeTransaction(currentTxnState,isReplay);
      TransactionState ts=m_transactionsById.remove(currentTxnState.txnId);
      assert(ts != null);
      return null;
    }
 else     if (currentTxnState.shouldResumeProcedure()) {
      Map<Integer,List<VoltTable>> retval=currentTxnState.getPreviousStackFrameDropDependendencies();
      assert(retval != null);
      return retval;
    }
 else     if (currentTxnState.isBlocked() && !currentTxnState.isDone() && currentTxnState.isCoordinator()&& currentTxnState.isReadOnly()&& !currentTxnState.hasTransactionalWork()) {
      assert(!currentTxnState.isSinglePartition());
      tryToSneakInASinglePartitionProcedure();
    }
 else {
      VoltMessage message=m_mailbox.recvBlocking(5);
      tick();
      if (message != null) {
        handleMailboxMessage(message);
      }
 else {
        m_snapshotter.doSnapshotWork(ee,EstTime.currentTimeMillis() - lastCommittedTxnTime > 5);
      }
      if (m_recoveryProcessor != null) {
        m_recoveryProcessor.notifyBlockedOnMultiPartTxn(currentTxnState.txnId);
      }
    }
  }
  return null;
}
