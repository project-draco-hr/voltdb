{
  final FileInputStream fis=new FileInputStream(f);
  try {
    final BufferedInputStream bis=new BufferedInputStream(fis);
    ByteBuffer crcBuffer=ByteBuffer.allocate(4);
    if (4 != bis.read(crcBuffer.array())) {
      throw new EOFException("EOF while attempting to read CRC from snapshot digest " + f + " on host "+ CoreUtils.getHostnameOrAddress());
    }
    final int crc=crcBuffer.getInt();
    final InputStreamReader isr=new InputStreamReader(bis,"UTF-8");
    CharArrayWriter caw=new CharArrayWriter();
    while (true) {
      int nextChar=isr.read();
      if (nextChar == -1) {
        break;
      }
      if (nextChar == '\n') {
        break;
      }
      caw.write(nextChar);
    }
    JSONObject obj=null;
    try {
      obj=new JSONObject(caw.toString());
    }
 catch (    JSONException e) {
    }
    if (obj == null) {
      String tableList=caw.toString();
      byte tableListBytes[]=tableList.getBytes("UTF-8");
      PureJavaCrc32 tableListCRC=new PureJavaCrc32();
      tableListCRC.update(tableListBytes);
      tableListCRC.update("\n".getBytes("UTF-8"));
      final int calculatedValue=(int)tableListCRC.getValue();
      if (crc != calculatedValue) {
        throw new IOException("CRC of snapshot digest did not match digest contents");
      }
      String tableNames[]=tableList.split(",");
      long txnId=Long.valueOf(tableNames[0]);
      obj=new JSONObject();
      try {
        obj.put("version",0);
        obj.put("txnId",txnId);
        for (int ii=1; ii < tableNames.length; ii++) {
          obj.append("tables",tableNames[ii]);
        }
      }
 catch (      JSONException e) {
        throw new IOException(e);
      }
      return obj;
    }
 else {
      String tableList=caw.toString();
      byte tableListBytes[]=tableList.getBytes("UTF-8");
      PureJavaCrc32 tableListCRC=new PureJavaCrc32();
      tableListCRC.update(tableListBytes);
      final int calculatedValue=(int)tableListCRC.getValue();
      if (crc != calculatedValue) {
        throw new IOException("CRC of snapshot digest did not match digest contents");
      }
      return obj;
    }
  }
  finally {
    try {
      if (fis != null)       fis.close();
    }
 catch (    IOException e) {
    }
  }
}
