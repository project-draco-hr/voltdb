import sys
import os.path
import shutil
import fnmatch
import subprocess
import time
from optparse import OptionParser
from subprocess import call
sys.path.append('../../src/py_client')
try:
    from voltdbclient import *
except ImportError:
    sys.path.append('./src/py_client')
    from voltdbclient import *
from Query import VoltQueryClient
pkgName = {'comm': 'LINUX-voltdb', 'pro': 'LINUX-voltdb-ent', }
tail = 'tar.gz'
root = 'http://volt0/kits/candidate/'
destDir = '/tmp/'
elem2Test = {'helloworld': 'run.sh', 'voltcache': 'run.sh', 'voltkv': 'run.sh', 'voter': 'run.sh', }
defaultHost = 'localhost'
defaultPort = 21212
if (__name__ == '__main__'):
    parser = OptionParser()
    parser.add_option('-r', '--release', dest='release', help='VoltDB release no. If ommitted, it will find it from version.txt.')
    parser.add_option('-p', '--pkg', dest='pkg', help='VoltDB package type: Community or Pro. Defalut is Community.')
    parser.add_option('-s', '--suite', dest='suite', help='Test suite name, if not set, then take all suites')
    parser.set_defaults(pkg='comm')
    parser.set_defaults(suite='all')
    (options, args) = parser.parse_args()
    workDir = (destDir + os.path.basename(os.path.abspath(__file__)).replace('.py', ''))
    print '============================================================'
    print ("options = '%s'" % options)
    print ("workDir = '%s'" % workDir)
    print ("options.release = '%s' options.pkg = '%s'" % (options.release, options.pkg))
    suite = options.suite
    if ((suite not in elem2Test.keys()) and (suite != 'all')):
        print ("Warning: unknown suite name - '%s'" % suite)
        print "Info: So we're going to cover all test suites in this run"
    origDir = os.getcwd()
    ret = installVoltDB(options.pkg, options.release)
    success = ret['ok']
    if (not success):
        print 'After installVoltDB() Test Failed!!'
        exit(1)
    testSuiteList = setExecutables(ret['workDir'], suite)
    for e in testSuiteList:
        executable = testSuiteList[e]
        print ("==-->>elem: '%s', executable: '%s'" % (e, executable))
    success = startTest(testSuiteList)
    for k in success:
        if (not success[k]):
            print ("Test '%s' Failed!!" % k)
        else:
            print ("Test '%s' passed!!" % k)
