{
  assert(SnapshotSiteProcessor.ExecutionSitesCurrentlySnapshotting.isEmpty());
  if (TheHashinator.getConfiguredHashinatorType() == HashinatorType.ELASTIC && hashinatorData == null) {
    throw new RuntimeException("No hashinator data provided for elastic hashinator type.");
  }
  final List<Table> tables=SnapshotUtil.getTablesToSave(context.getDatabase());
  m_snapshotRecord=SnapshotRegistry.startSnapshot(txnId,context.getHostId(),file_path,file_nonce,SnapshotFormat.NATIVE,tables.toArray(new Table[0]));
  final ArrayList<SnapshotTableTask> partitionedSnapshotTasks=new ArrayList<SnapshotTableTask>();
  final ArrayList<SnapshotTableTask> replicatedSnapshotTasks=new ArrayList<SnapshotTableTask>();
  for (  final Table table : tables) {
    final SnapshotTableTask task=new SnapshotTableTask(table,new SnapshotDataFilter[0],null,false);
    SNAP_LOG.debug("ADDING TASK: " + task);
    if (table.getIsreplicated()) {
      replicatedSnapshotTasks.add(task);
    }
 else {
      partitionedSnapshotTasks.add(task);
    }
    result.addRow(context.getHostId(),CoreUtils.getHostnameOrAddress(),table.getTypeName(),"SUCCESS","");
  }
  if (!tables.isEmpty() && replicatedSnapshotTasks.isEmpty() && partitionedSnapshotTasks.isEmpty()) {
    SnapshotRegistry.discardSnapshot(m_snapshotRecord);
  }
  placePartitionedTasks(partitionedSnapshotTasks,tracker.getSitesForHost(context.getHostId()));
  placeReplicatedTasks(replicatedSnapshotTasks,tracker.getSitesForHost(context.getHostId()));
  return createDeferredSetup(file_path,file_nonce,txnId,partitionTransactionIds,context,exportSequenceNumbers,tracker,hashinatorData,timestamp,newPartitionCount,tables,m_snapshotRecord,partitionedSnapshotTasks,replicatedSnapshotTasks);
}
