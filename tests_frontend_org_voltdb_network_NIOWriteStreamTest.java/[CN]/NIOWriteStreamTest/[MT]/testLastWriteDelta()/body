{
  final MockChannel channel=new MockChannel(MockChannel.SINK);
  MockPort port=new MockPort();
  NIOWriteStream wstream=new NIOWriteStream(port);
  assertEquals(0,wstream.calculatePendingWriteDelta(999));
  EstTimeUpdater.update(System.currentTimeMillis());
  final ByteBuffer b=ByteBuffer.allocate(5);
  wstream.enqueue(b.duplicate());
  assertEquals(5,wstream.calculatePendingWriteDelta(EstTime.currentTimeMillis() + 5));
  wstream.drainTo(channel,wstream.swapAndSerializeQueuedWrites(pool));
  assertEquals(0,wstream.calculatePendingWriteDelta(EstTime.currentTimeMillis() + 5));
  Thread.sleep(20);
  EstTimeUpdater.update(System.currentTimeMillis());
  wstream.enqueue(b.duplicate());
  assertEquals(5,wstream.calculatePendingWriteDelta(EstTime.currentTimeMillis() + 5));
  wstream.enqueue(b.duplicate());
  assertEquals(5,wstream.calculatePendingWriteDelta(EstTime.currentTimeMillis() + 5));
  channel.m_behavior=MockChannel.PARTIAL;
  wstream.drainTo(channel,wstream.swapAndSerializeQueuedWrites(pool));
  assertEquals(5,wstream.calculatePendingWriteDelta(EstTime.currentTimeMillis() + 5));
  wstream.shutdown();
}
