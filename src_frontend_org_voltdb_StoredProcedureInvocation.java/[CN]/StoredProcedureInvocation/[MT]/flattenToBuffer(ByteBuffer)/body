{
  assert((params != null) || (serializedParams != null));
  int startPosition=buf.position();
  buf.put(CURRENT_MOST_RECENT_VERSION);
  SerializationHelper.writeVarbinary(getProcNameBytes(),buf);
  buf.putLong(clientHandle);
  byte extensionCount=0;
  if (m_batchTimeout != BatchTimeoutOverrideType.NO_TIMEOUT)   ++extensionCount;
  if (m_allPartition)   ++extensionCount;
  buf.put(extensionCount);
  if (m_batchTimeout != BatchTimeoutOverrideType.NO_TIMEOUT) {
    ProcedureInvocationExtensions.writeBatchTimeoutWithTypeByte(buf,m_batchTimeout);
  }
  if (m_allPartition) {
    ProcedureInvocationExtensions.writeAllPartitionWithTypeByte(buf);
  }
  if (serializedParams != null) {
    if (serializedParams.hasArray()) {
      assert(serializedParams.position() == 0);
      buf.put(serializedParams.array(),serializedParams.position() + serializedParams.arrayOffset(),serializedParams.remaining());
    }
 else {
      assert(serializedParams.position() == 0);
      ByteBuffer dup=serializedParams.duplicate();
      dup.rewind();
      buf.put(dup);
    }
  }
 else   if (params != null) {
    try {
      getParams().flattenToBuffer(buf);
    }
 catch (    BufferOverflowException e) {
      hostLog.info("SP \"" + procName + "\" has thrown BufferOverflowException");
      hostLog.info(toString());
      throw e;
    }
  }
  int len=buf.position() - startPosition;
  assert(len == getSerializedSize());
}
