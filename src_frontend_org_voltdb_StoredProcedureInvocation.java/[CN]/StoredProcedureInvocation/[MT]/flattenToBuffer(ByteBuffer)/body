{
  if (debug) {
    hostLog.info("UAC flattenToBuffer for: " + toStringLite());
  }
  assert(!((params == null) && (serializedParams == null)));
  assert((params != null) || (serializedParams != null));
  int startPos=buf.position();
  buf.put(type.getValue());
  if (type == ProcedureInvocationType.REPLICATED) {
    buf.putLong(originalTxnId);
    buf.putLong(originalUniqueId);
  }
  buf.putInt(procName.length());
  buf.put(procName.getBytes());
  buf.putLong(clientHandle);
  int beforeParamPos=buf.position();
  if (debug) {
    hostLog.info(String.format("UAC Invocation flattenToBuffer serialized %d bytes before it got to params.",beforeParamPos - startPos));
  }
  if (serializedParams != null) {
    if (!serializedParams.isReadOnly()) {
      assert(serializedParams.position() == 0);
      buf.put(serializedParams.array(),serializedParams.position() + serializedParams.arrayOffset(),serializedParams.remaining());
    }
 else {
      assert(serializedParams.position() == 0);
      ByteBuffer dup=serializedParams.duplicate();
      dup.rewind();
      buf.put(dup);
    }
  }
 else   if (params != null) {
    try {
      getParams().flattenToBuffer(buf);
    }
 catch (    BufferOverflowException e) {
      hostLog.info("SP \"" + procName + "\" has thrown BufferOverflowException");
      hostLog.info(toString());
      throw e;
    }
  }
  int endPos=buf.position();
  if (debug) {
    hostLog.info(String.format("UAC Invocation flattenToBuffer serialized %d param bytes and %d total.",endPos - beforeParamPos,endPos - startPos));
  }
}
