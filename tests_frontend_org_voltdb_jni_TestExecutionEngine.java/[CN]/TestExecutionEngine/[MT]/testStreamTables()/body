{
  final Catalog catalog=new Catalog();
  catalog.execute(LoadCatalogToString.THE_CATALOG);
  engine.loadCatalog(catalog.serialize());
  ExecutionEngine engine2=new ExecutionEngineJNI(null,CLUSTER_ID,NODE_ID,0,0,"");
  engine2.loadCatalog(catalog.serialize());
  int WAREHOUSE_TABLEID=warehouseTableId(catalog);
  int STOCK_TABLEID=stockTableId(catalog);
  loadTestTables(catalog);
  engine.activateTableStream(WAREHOUSE_TABLEID,TableStreamType.RECOVERY);
  engine.activateTableStream(STOCK_TABLEID,TableStreamType.RECOVERY);
  BBContainer origin=DBBPool.allocateDirect(1024 * 1024 * 2);
  try {
    origin.b.clear();
    long address=org.voltdb.utils.DBBPool.getBufferAddress(origin.b);
    BBContainer container=new BBContainer(origin.b,address){
      @Override public void discard(){
      }
    }
;
    int serialized=engine.tableStreamSerializeMore(container,WAREHOUSE_TABLEID,TableStreamType.RECOVERY);
    assertTrue(serialized > 0);
    container.b.limit(serialized);
    byte data[]=new byte[serialized];
    container.b.get(data);
    container.b.clear();
    engine2.processRecoveryMessage(data);
    serialized=engine.tableStreamSerializeMore(container,WAREHOUSE_TABLEID,TableStreamType.RECOVERY);
    assertEquals(5,serialized);
    assertEquals(RecoveryMessageType.Complete.ordinal(),container.b.get());
    assertEquals(WAREHOUSE_TABLEID,container.b.getInt());
    assertEquals(engine.tableHashCode(WAREHOUSE_TABLEID),engine2.tableHashCode(WAREHOUSE_TABLEID));
  }
  finally {
    origin.discard();
  }
}
