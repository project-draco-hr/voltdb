{
  if ((map instanceof ImmutableMap) && !(map instanceof ImmutableSortedMap)) {
    @SuppressWarnings("unchecked") ImmutableMap<K,V> kvMap=(ImmutableMap<K,V>)map;
    if (!kvMap.isPartialView()) {
      return kvMap;
    }
  }
 else   if (map instanceof EnumMap) {
    return copyOfEnumMapUnsafe(map);
  }
  Entry<?,?>[] entries=map.entrySet().toArray(EMPTY_ENTRY_ARRAY);
switch (entries.length) {
case 0:
    return of();
case 1:
  @SuppressWarnings("unchecked") Entry<K,V> onlyEntry=(Entry<K,V>)entries[0];
return of(onlyEntry.getKey(),onlyEntry.getValue());
default :
return new RegularImmutableMap<K,V>(entries);
}
}
