{
  assert(jarFileName != null);
  assert(siteCount > 0);
  assert(hostCount > 0);
  m_additionalProcessEnv=env;
  StackTraceElement[] traces=Thread.currentThread().getStackTrace();
  m_callingClassName="UnknownClass";
  m_callingMethodName="unknownMethod";
  int i;
  for (i=0; traces[i].getClassName().equals(getClass().getName()) == false; i++)   ;
  for (; traces[i].getClassName().equals(getClass().getName()); i++)   ;
  int dot=traces[i].getClassName().lastIndexOf('.');
  m_callingClassName=traces[i].getClassName().substring(dot + 1);
  m_callingMethodName=traces[i].getMethodName();
  log.info("Instantiating LocalCluster for " + jarFileName + " with class.method: "+ m_callingClassName+ "."+ m_callingMethodName);
  log.info("Sites: " + siteCount + " hosts: "+ hostCount+ " replication factor: "+ kfactor);
  m_cluster.ensureCapacity(hostCount);
  m_siteCount=siteCount;
  m_hostCount=hostCount;
  if (kfactor > 0 && !MiscUtils.isPro()) {
    m_kfactor=0;
  }
 else {
    m_kfactor=kfactor;
  }
  m_debug=debug;
  m_jarFileName=jarFileName;
  m_failureState=m_kfactor < 1 ? FailureState.ALL_RUNNING : failureState;
  m_pipes=new ArrayList<PipeToFile>();
  m_cmdLines=new ArrayList<CommandLine>();
  if (isMemcheckDefined() && (target == BackendTarget.NATIVE_EE_JNI) && m_hostCount == 1) {
    m_target=BackendTarget.NATIVE_EE_VALGRIND_IPC;
  }
 else {
    m_target=target;
  }
  String buildDir=System.getenv("VOLTDB_BUILD_DIR");
  if (buildDir == null) {
    buildDir=System.getProperty("user.dir") + "/obj/release";
  }
  String classPath=System.getProperty("java.class.path") + ":" + buildDir+ File.separator+ m_jarFileName;
  String javaLibraryPath=null;
  if (m_additionalProcessEnv != null && m_additionalProcessEnv.containsKey(EELibraryLoader.USE_JAVA_LIBRARY_PATH)) {
    if (Boolean.parseBoolean(m_additionalProcessEnv.get(EELibraryLoader.USE_JAVA_LIBRARY_PATH))) {
      javaLibraryPath=System.getProperty("java.library.path");
      if (javaLibraryPath == null || javaLibraryPath.trim().length() == 0) {
        javaLibraryPath=buildDir + "/nativelibs";
      }
 else {
        javaLibraryPath+=":" + buildDir + "/nativelibs";
      }
    }
  }
  if (javaLibraryPath == null) {
    classPath=classPath + ":" + buildDir+ File.separator+ "prod";
  }
  classPath=classPath.replace(buildDir + File.separator + "testprocs:","");
  String log4j=System.getProperty("log4j.configuration");
  if (log4j == null) {
    log4j="file://" + System.getProperty("user.dir") + "/tests/log4j-allconsole.xml";
  }
  m_procBuilder=new ProcessBuilder();
  m_procBuilder.redirectErrorStream(true);
  Thread shutdownThread=new Thread(new ShutDownHookThread());
  java.lang.Runtime.getRuntime().addShutdownHook(shutdownThread);
  this.templateCmdLine.addTestOptions(true).leader("").target(m_target).startCommand("create").jarFileName(VoltDB.Configuration.getPathToCatalogForTest(m_jarFileName)).buildDir(buildDir).classPath(classPath).pathToLicense(ServerThread.getTestLicensePath()).log4j(log4j);
  if (javaLibraryPath != null) {
    templateCmdLine.javaLibraryPath(javaLibraryPath);
  }
  this.templateCmdLine.m_noLoadLibVOLTDB=m_target == BackendTarget.HSQLDB_BACKEND;
  this.templateCmdLine.m_tag=m_callingClassName + ":" + m_callingMethodName;
}
