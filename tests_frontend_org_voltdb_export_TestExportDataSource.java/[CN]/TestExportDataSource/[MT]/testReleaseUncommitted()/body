{
  VoltDB.replaceVoltDBInstanceForTest(m_mockVoltDB);
  Table table=m_mockVoltDB.getCatalogContext().database.getTables().get("TableName");
  ExportDataSource s=new ExportDataSource(Mockito.mock(Runnable.class),"database",table.getTypeName(),m_part,m_site,table.getSignature(),0,table.getColumns(),"/tmp");
  ExportProtoMessage m=new ExportProtoMessage(0,m_part,table.getSignature());
  final AtomicReference<ExportProtoMessage> ref=new AtomicReference<ExportProtoMessage>();
  ExportStateBlock esb=new ExportStateBlock(){
    @Override public void event(    ExportProtoMessage m){
      ref.set(m);
    }
  }
;
  ExportInternalMessage pair=new ExportInternalMessage(esb,m);
  m.poll();
  s.exportAction(pair).get();
  m=ref.get();
  assertEquals(m.getAckOffset(),0);
  assertEquals(m.m_data.getInt(),0);
  ByteBuffer firstBuffer=ByteBuffer.allocate(MAGIC_TUPLE_SIZE * 3);
  s.pushExportBuffer(0,0,firstBuffer,false,false);
  m.ack(MAGIC_TUPLE_SIZE * 2);
  m.poll();
  pair=new ExportInternalMessage(esb,m);
  s.exportAction(pair).get();
  m.close();
  pair=new ExportInternalMessage(esb,m);
  s.exportAction(pair).get();
  m=ref.get();
  assertEquals(m.getAckOffset(),MAGIC_TUPLE_SIZE * 3);
  m.m_data.order(java.nio.ByteOrder.LITTLE_ENDIAN);
  assertEquals(m.m_data.getInt(),MAGIC_TUPLE_SIZE);
  m=new ExportProtoMessage(0,m_part,table.getSignature());
  m.poll();
  pair=new ExportInternalMessage(esb,m);
  m.ack(MAGIC_TUPLE_SIZE * 10);
  s.exportAction(pair).get();
  m=ref.get();
  assertEquals(m.getAckOffset(),MAGIC_TUPLE_SIZE * 3);
  assertEquals(m.m_data.getInt(),0);
  ByteBuffer secondBuffer=ByteBuffer.allocate(MAGIC_TUPLE_SIZE * 6);
  s.pushExportBuffer(MAGIC_TUPLE_SIZE * 3,0,secondBuffer,false,false);
  m.ack(MAGIC_TUPLE_SIZE * 3);
  m.poll();
  pair=new ExportInternalMessage(esb,m);
  s.exportAction(pair).get();
  m=ref.get();
  assertEquals(m.getAckOffset(),MAGIC_TUPLE_SIZE * 9);
  m.m_data.order(java.nio.ByteOrder.LITTLE_ENDIAN);
  assertEquals(m.m_data.getInt(),MAGIC_TUPLE_SIZE * 6);
}
