{
  VoltTable[] results;
  SynthesizedPlanFragment pfs[];
  Table catTable=m_cluster.getDatabases().get("database").getTables().getIgnoreCase(tableName);
  if (catTable == null) {
    throw new VoltAbortException("Table not present in catalog.");
  }
  if (catTable.getIsreplicated()) {
    pfs=new SynthesizedPlanFragment[2];
    pfs[1]=new SynthesizedPlanFragment();
    pfs[1].fragmentId=SysProcFragmentId.PF_distribute;
    pfs[1].outputDepId=DEP_distribute;
    pfs[1].inputDepIds=new int[]{};
    pfs[1].multipartition=true;
    pfs[1].nonExecSites=false;
    ParameterSet params=new ParameterSet();
    params.setParameters(tableName,table);
    pfs[1].parameters=params;
    pfs[0]=new SynthesizedPlanFragment();
    pfs[0].fragmentId=SysProcFragmentId.PF_aggregate;
    pfs[0].outputDepId=DEP_aggregate;
    pfs[0].inputDepIds=new int[]{DEP_distribute};
    pfs[0].multipartition=false;
    pfs[0].nonExecSites=false;
    pfs[0].parameters=new ParameterSet();
    results=executeSysProcPlanFragments(pfs,DEP_aggregate);
    return results;
  }
 else {
    int partitionCol=catTable.getPartitioncolumn().getIndex();
    int intType=catTable.getPartitioncolumn().getType();
    VoltType partitionType=VoltType.get((byte)intType);
    int numPartitions=m_cluster.getPartitions().size();
    VoltTable partitionedTables[]=new VoltTable[numPartitions];
    for (int i=0; i < partitionedTables.length; i++) {
      partitionedTables[i]=table.clone(1024 * 1024);
    }
    while (table.advanceRow()) {
      int p=0;
      try {
        p=TheHashinator.hashToPartition(table.get(partitionCol,partitionType));
      }
 catch (      Exception e) {
        e.printStackTrace();
        throw new RuntimeException(e.getMessage());
      }
      partitionedTables[p].add(table);
    }
    int num_exec_sites=VoltDB.instance().getNumberOfExecSites();
    pfs=new SynthesizedPlanFragment[num_exec_sites + 1];
    int site_index=0;
    for (    Site site : m_cluster.getSites()) {
      if (!site.getIsexec()) {
        continue;
      }
      ParameterSet params=new ParameterSet();
      int site_id=Integer.valueOf(site.getTypeName());
      int partition=VoltDB.instance().getSiteTracker().getPartitionForSite(site_id);
      params.setParameters(tableName,partitionedTables[partition]);
      pfs[site_index]=new SynthesizedPlanFragment();
      pfs[site_index].fragmentId=SysProcFragmentId.PF_distribute;
      pfs[site_index].outputDepId=DEP_distribute;
      pfs[site_index].inputDepIds=new int[]{};
      pfs[site_index].multipartition=false;
      pfs[site_index].nonExecSites=false;
      pfs[site_index].siteId=Integer.valueOf(site.getTypeName());
      pfs[site_index].parameters=params;
      site_index++;
    }
    pfs[num_exec_sites]=new SynthesizedPlanFragment();
    pfs[num_exec_sites].fragmentId=SysProcFragmentId.PF_aggregate;
    pfs[num_exec_sites].inputDepIds=new int[]{DEP_distribute};
    pfs[num_exec_sites].outputDepId=DEP_aggregate;
    pfs[num_exec_sites].multipartition=false;
    pfs[num_exec_sites].nonExecSites=false;
    pfs[num_exec_sites].parameters=new ParameterSet();
    results=executeSysProcPlanFragments(pfs,DEP_aggregate);
    return results;
  }
}
