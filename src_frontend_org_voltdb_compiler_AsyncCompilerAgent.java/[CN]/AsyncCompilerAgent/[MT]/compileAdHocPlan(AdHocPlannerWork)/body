{
  AdHocPlannedStmt plannedStmt=new AdHocPlannedStmt();
  plannedStmt.clientHandle=work.clientHandle;
  plannedStmt.connectionId=work.connectionId;
  plannedStmt.hostname=work.hostname;
  plannedStmt.adminConnection=work.adminConnection;
  plannedStmt.clientData=work.clientData;
  CatalogContext context=VoltDB.instance().getCatalogContext();
  if (m_ptool == null || m_ptool.m_context.catalogVersion != context.catalogVersion) {
    if (m_ptool != null) {
      m_ptool.shutdown();
    }
    m_ptool=new PlannerTool(context);
  }
  plannedStmt.catalogVersion=context.catalogVersion;
  try {
    PlannerTool.Result result=m_ptool.planSql(work.sql,work.partitionParam);
    plannedStmt.aggregatorFragment=result.onePlan;
    plannedStmt.collectorFragment=result.allPlan;
    plannedStmt.isReplicatedTableDML=result.replicatedDML;
    plannedStmt.sql=work.sql;
    plannedStmt.partitionParam=result.partitionParam;
  }
 catch (  Exception e) {
    plannedStmt.errorMsg="Unexpected Ad Hoc Planning Error: " + e.getMessage();
  }
  return plannedStmt;
}
