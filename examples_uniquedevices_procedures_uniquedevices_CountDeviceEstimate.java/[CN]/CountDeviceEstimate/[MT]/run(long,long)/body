{
  long current=0;
  HyperLogLog hll=null;
  voltQueueSQL(estimatesSelect,EXPECT_ZERO_OR_ONE_ROW,appId);
  VoltTable estimatesTable=voltExecuteSQL()[0];
  if (estimatesTable.advanceRow()) {
    estimatesTable.advanceRow();
    current=estimatesTable.getLong("devicecount");
    byte[] hllBytes=estimatesTable.getVarbinary("hll");
    hll=HyperLogLog.fromBytes(hllBytes);
  }
 else {
    hll=new HyperLogLog(12);
  }
  hll.offerHashed(hashedDeviceId);
  if (hll.getDirty()) {
    current=Math.max(MAX_EXACT_COUNT,hll.cardinality());
    voltQueueSQL(estimatesUpsert,EXPECT_SCALAR_MATCH(1),appId,current,hll.toBytes());
    voltExecuteSQL(true);
  }
  return current;
}
