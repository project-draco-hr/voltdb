{
  VoltDB.instance().readBuildInfo("Test");
  String testDir=BuildDirectoryUtils.getBuildDirectoryPath();
  String catalogJar=testDir + File.separator + JAR;
  TPCCProjectBuilder pb=new TPCCProjectBuilder();
  pb.addDefaultSchema();
  pb.addDefaultPartitioning();
  pb.addProcedures(MultiSiteSelect.class,InsertNewOrder.class);
  pb.compile(catalogJar,2,0);
  byte[] bytes=CatalogUtil.toBytes(new File(catalogJar));
  String serializedCatalog=CatalogUtil.loadCatalogFromJar(bytes,null);
  catalog=new Catalog();
  catalog.execute(serializedCatalog);
  String pathToDeployment=pb.getPathToDeployment();
  assertTrue(CatalogUtil.compileDeploymentAndGetCRC(catalog,pathToDeployment,true) >= 0);
  cluster=catalog.getClusters().get("cluster");
  CatalogMap<Procedure> procedures=cluster.getDatabases().get("database").getProcedures();
  Procedure insertProc=procedures.get("InsertNewOrder");
  assert(insertProc != null);
  selectProc=procedures.get("MultiSiteSelect");
  assert(selectProc != null);
  final AtomicReference<ExecutionEngine> site1Reference=new AtomicReference<ExecutionEngine>();
  final byte configBytes[]=LegacyHashinator.getConfigureBytes(2);
  Thread site1Thread=new Thread(){
    @Override public void run(){
      site1Reference.set(new ExecutionEngineJNI(cluster.getRelativeIndex(),1,0,0,"",100,HashinatorType.LEGACY,configBytes));
    }
  }
;
  site1Thread.start();
  site1Thread.join();
  final AtomicReference<ExecutionEngine> site2Reference=new AtomicReference<ExecutionEngine>();
  Thread site2Thread=new Thread(){
    @Override public void run(){
      site2Reference.set(new ExecutionEngineJNI(cluster.getRelativeIndex(),2,1,0,"",100,HashinatorType.LEGACY,configBytes));
    }
  }
;
  site2Thread.start();
  site2Thread.join();
  site1=new ExecutionSite(0);
  ee1=site1Reference.get();
  ee1.loadCatalog(0,catalog.serialize());
  site2=new ExecutionSite(1);
  ee2=site2Reference.get();
  ee2.loadCatalog(0,catalog.serialize());
  selectStmt=selectProc.getStatements().get("selectAll");
  assert(selectStmt != null);
  int i=0;
  for (  PlanFragment f : selectStmt.getFragments()) {
    if (i == 0)     selectTopFrag=f;
 else     selectBottomFrag=f;
    i++;
  }
  assert(selectTopFrag != null);
  assert(selectBottomFrag != null);
  if (selectTopFrag.getHasdependencies() == false) {
    PlanFragment temp=selectTopFrag;
    selectTopFrag=selectBottomFrag;
    selectBottomFrag=temp;
  }
  Statement insertStmt=insertProc.getStatements().get("insert");
  assert(insertStmt != null);
  PlanFragment insertFrag=null;
  for (  PlanFragment f : insertStmt.getFragments())   insertFrag=f;
  ParameterSet params=new ParameterSet();
  params.setParameters(1L,1L,1L);
  VoltTable[] results=ee2.executePlanFragments(1,new long[]{CatalogUtil.getUniqueIdForFragment(insertFrag)},null,new ParameterSet[]{params},1,0,42,Long.MAX_VALUE);
  assert(results.length == 1);
  assert(results[0].asScalarLong() == 1L);
  params=new ParameterSet();
  params.setParameters(2L,2L,2L);
  results=ee1.executePlanFragments(1,new long[]{CatalogUtil.getUniqueIdForFragment(insertFrag)},null,new ParameterSet[]{params},2,1,42,Long.MAX_VALUE);
  assert(results.length == 1);
  assert(results[0].asScalarLong() == 1L);
}
