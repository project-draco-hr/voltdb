{
  FragmentTaskMessage msg=message;
  long newSpHandle;
  if (m_isLeader) {
    msg=new FragmentTaskMessage(message.getInitiatorHSId(),message.getCoordinatorHSId(),message);
    newSpHandle=m_txnId.incrementAndGet();
    msg.setSpHandle(newSpHandle);
    if (m_replicaHSIds.length > 0 && inputDeps == null) {
      try {
        FragmentTaskMessage replmsg=new FragmentTaskMessage(m_mailbox.getHSId(),m_mailbox.getHSId(),msg);
        m_mailbox.send(m_replicaHSIds,replmsg);
      }
 catch (      MessagingException e) {
        hostLog.error("Failed to deliver response from execution site.",e);
      }
      DuplicateCounter counter=new DuplicateCounter(msg.getCoordinatorHSId(),m_replicaHSIds.length + 1,msg.getTxnId());
      m_duplicateCounters.put(newSpHandle,counter);
    }
  }
 else {
    newSpHandle=msg.getSpHandle();
  }
  TransactionState txn=m_outstandingTxns.get(msg.getTxnId());
  if (txn == null) {
    txn=new ParticipantTransactionState(newSpHandle,msg);
    m_outstandingTxns.put(msg.getTxnId(),txn);
  }
  if (msg.isSysProcTask()) {
    final SysprocFragmentTask task=new SysprocFragmentTask(m_mailbox,(ParticipantTransactionState)txn,m_pendingTasks,msg,inputDeps);
    m_pendingTasks.offer(task);
  }
 else {
    final FragmentTask task=new FragmentTask(m_mailbox,(ParticipantTransactionState)txn,m_pendingTasks,msg,inputDeps);
    m_pendingTasks.offer(task);
  }
}
