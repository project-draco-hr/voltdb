{
  long newSpHandle;
  if (m_isLeader) {
    newSpHandle=m_txnId.incrementAndGet();
    message.setSpHandle(newSpHandle);
    if (m_replicaHSIds.length > 0 && inputDeps == null) {
      try {
        FragmentTaskMessage replmsg=new FragmentTaskMessage(m_mailbox.getHSId(),m_mailbox.getHSId(),message);
        m_mailbox.send(m_replicaHSIds,replmsg);
      }
 catch (      MessagingException e) {
        hostLog.error("Failed to deliver response from execution site.",e);
      }
      DuplicateCounter counter=new DuplicateCounter(message.getCoordinatorHSId(),m_replicaHSIds.length + 1,message.getTxnId());
      m_duplicateCounters.put(newSpHandle,counter);
    }
  }
 else {
    newSpHandle=message.getSpHandle();
  }
  TransactionState txn=m_outstandingTxns.get(message.getTxnId());
  if (txn == null) {
    txn=new ParticipantTransactionState(newSpHandle,message);
    m_outstandingTxns.put(message.getTxnId(),txn);
  }
  if (message.isSysProcTask()) {
    final SysprocFragmentTask task=new SysprocFragmentTask(m_mailbox,(ParticipantTransactionState)txn,m_pendingTasks,message,inputDeps);
    m_pendingTasks.offer(task);
  }
 else {
    final FragmentTask task=new FragmentTask(m_mailbox,(ParticipantTransactionState)txn,m_pendingTasks,message,inputDeps);
    m_pendingTasks.offer(task);
  }
}
