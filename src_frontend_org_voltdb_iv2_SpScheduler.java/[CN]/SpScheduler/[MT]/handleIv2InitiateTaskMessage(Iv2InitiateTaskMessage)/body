{
  final String procedureName=message.getStoredProcedureName();
  final ProcedureRunner runner=m_loadedProcs.getProcByName(procedureName);
  if (message.isSinglePartition()) {
    long newSpHandle;
    Iv2InitiateTaskMessage msg=message;
    if (m_isLeader) {
      msg=new Iv2InitiateTaskMessage(message.getInitiatorHSId(),message.getCoordinatorHSId(),m_repairLogTruncationHandle,message.getTxnId(),message.isReadOnly(),message.isSinglePartition(),message.getStoredProcedureInvocation(),message.getClientInterfaceHandle(),message.getConnectionId());
      newSpHandle=m_txnId.incrementAndGet();
      msg.setSpHandle(newSpHandle);
      if (!runner.isEverySite()) {
        msg.setTxnId(newSpHandle);
      }
      if (m_replicaHSIds.size() > 0) {
        Iv2InitiateTaskMessage replmsg=new Iv2InitiateTaskMessage(m_mailbox.getHSId(),m_mailbox.getHSId(),m_repairLogTruncationHandle,msg.getTxnId(),msg.isReadOnly(),msg.isSinglePartition(),msg.getStoredProcedureInvocation(),msg.getClientInterfaceHandle(),msg.getConnectionId());
        replmsg.setSpHandle(newSpHandle);
        m_mailbox.send(com.google.common.primitives.Longs.toArray(m_replicaHSIds),replmsg);
        List<Long> expectedHSIds=new ArrayList<Long>(m_replicaHSIds);
        expectedHSIds.add(m_mailbox.getHSId());
        DuplicateCounter counter=new DuplicateCounter(msg.getInitiatorHSId(),msg.getTxnId(),expectedHSIds);
        m_duplicateCounters.put(newSpHandle,counter);
      }
    }
 else {
      newSpHandle=msg.getSpHandle();
      m_txnId.set(newSpHandle);
    }
    Iv2Trace.logIv2InitiateTaskMessage(message,m_mailbox.getHSId(),msg.getTxnId(),newSpHandle);
    final SpProcedureTask task=new SpProcedureTask(m_mailbox,runner,newSpHandle,m_pendingTasks,msg);
    m_pendingTasks.offer(task);
    return;
  }
 else {
    throw new RuntimeException("SpScheduler.handleIv2InitiateTaskMessage " + "should never receive multi-partition initiations.");
  }
}
