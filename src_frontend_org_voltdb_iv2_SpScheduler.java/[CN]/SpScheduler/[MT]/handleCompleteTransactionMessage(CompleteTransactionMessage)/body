{
  CompleteTransactionMessage msg=message;
  if (m_isLeader) {
    msg=new CompleteTransactionMessage(message);
    advanceTxnEgo();
    msg.setSpHandle(getCurrentTxnId());
    if (m_sendToHSIds.length > 0) {
      m_mailbox.send(m_sendToHSIds,msg);
    }
  }
 else {
    setMaxSeenTxnId(msg.getSpHandle());
  }
  TransactionState txn=m_outstandingTxns.get(msg.getTxnId());
  if (txn != null) {
    Iv2Trace.logCompleteTransactionMessage(msg,m_mailbox.getHSId());
    final CompleteTransactionTask task=new CompleteTransactionTask(txn,m_pendingTasks,msg,m_drGateway);
    queueOrOfferMPTask(task);
    if (!msg.isRestart()) {
      m_outstandingTxns.remove(msg.getTxnId());
    }
  }
}
