{
  MockChannel channel=new MockChannel(MockChannel.PARTIAL);
  MockPort port=new MockPort();
  NIOWriteStream wstream=new NIOWriteStream(port);
  assertTrue(wstream.isEmpty());
  ByteBuffer tmp=ByteBuffer.allocate(5);
  tmp.put((byte)1);
  tmp.put((byte)2);
  tmp.put((byte)3);
  tmp.put((byte)4);
  tmp.flip();
  assertTrue(wstream.enqueue(tmp));
  assertTrue(port.checkWriteSet());
  int wrote=wstream.drainTo(channel,wstream.swapAndSerializeQueuedWrites(pool));
  assertFalse(wstream.isEmpty());
  assertEquals(2,wrote);
  channel.wrotePartial=false;
  ByteBuffer tmp2=ByteBuffer.allocate(4);
  tmp2.put((byte)5);
  tmp2.put((byte)6);
  tmp2.put((byte)7);
  tmp2.put((byte)8);
  tmp2.flip();
  wstream.enqueue(tmp2);
  org.voltcore.utils.DBBPool.BBContainer containers[]=wstream.swapAndSerializeQueuedWrites(pool);
  wrote+=wstream.drainTo(channel,containers);
  assertFalse(wstream.isEmpty());
  assertEquals(3,wrote);
  channel.m_behavior=MockChannel.SINK;
  wrote+=wstream.drainTo(channel,wstream.swapAndSerializeQueuedWrites(pool));
  assertEquals(8,wrote);
  assertTrue(wstream.isEmpty());
  wstream.shutdown();
}
