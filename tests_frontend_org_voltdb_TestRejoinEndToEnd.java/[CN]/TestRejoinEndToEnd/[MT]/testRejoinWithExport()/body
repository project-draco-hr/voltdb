{
  VoltProjectBuilder builder=getBuilderForTest();
  builder.addExportTable("blah",false);
  builder.addExportTable("blah_replicated",false);
  builder.addExportTable("PARTITIONED",false);
  builder.addExportTable("PARTITIONED_LARGE",false);
  builder.addExport("org.voltdb.export.processors.RawProcessor",true,null);
  LocalCluster cluster=new LocalCluster("rejoin.jar",2,3,1,BackendTarget.NATIVE_EE_JNI);
  boolean success=cluster.compile(builder);
  assertTrue(success);
  copyFile(builder.getPathToDeployment(),Configuration.getPathToCatalogForTest("rejoin.xml"));
  cluster.setHasLocalServer(false);
  cluster.startUp();
  ClientResponse response;
  Client client;
  client=ClientFactory.createClient(m_cconfig);
  client.createConnection("localhost");
  response=client.callProcedure("InsertSinglePartition",0);
  assertEquals(ClientResponse.SUCCESS,response.getStatus());
  response=client.callProcedure("Insert",1);
  assertEquals(ClientResponse.SUCCESS,response.getStatus());
  response=client.callProcedure("InsertReplicated",0);
  assertEquals(ClientResponse.SUCCESS,response.getStatus());
  client.close();
  client=ClientFactory.createClient(m_cconfig);
  client.createConnection("localhost",21213);
  response=client.callProcedure("InsertSinglePartition",2);
  assertEquals(ClientResponse.SUCCESS,response.getStatus());
  response=client.callProcedure("Insert",3);
  assertEquals(ClientResponse.SUCCESS,response.getStatus());
  client.close();
  TrivialExportClient exportClient=new TrivialExportClient();
  exportClient.work();
  exportClient.work();
  Thread.sleep(4000);
  exportClient.work();
  Thread.sleep(4000);
  exportClient.work();
  cluster.shutDownSingleHost(0);
  Thread.sleep(100);
  VoltDB.Configuration config=new VoltDB.Configuration();
  config.m_pathToCatalog=Configuration.getPathToCatalogForTest("rejoin.jar");
  config.m_pathToDeployment=Configuration.getPathToCatalogForTest("rejoin.xml");
  config.m_rejoinToHostAndPort=m_username + ":" + m_password+ "@localhost:21213";
  ServerThread localServer=new ServerThread(config);
  localServer.start();
  localServer.waitForInitialization();
  client=ClientFactory.createClient(m_cconfig);
  client.createConnection("localhost");
  response=client.callProcedure("InsertSinglePartition",5);
  assertEquals(ClientResponse.SUCCESS,response.getStatus());
  response=client.callProcedure("Insert",6);
  assertEquals(ClientResponse.SUCCESS,response.getStatus());
  response=client.callProcedure("InsertReplicated",7);
  assertEquals(ClientResponse.SUCCESS,response.getStatus());
  client.close();
  client=ClientFactory.createClient(m_cconfig);
  client.createConnection("localhost",21213);
  response=client.callProcedure("InsertSinglePartition",8);
  assertEquals(ClientResponse.SUCCESS,response.getStatus());
  response=client.callProcedure("Insert",9);
  assertEquals(ClientResponse.SUCCESS,response.getStatus());
  client.close();
  exportClient=new TrivialExportClient();
  exportClient.work();
  Thread.sleep(4000);
  exportClient.work();
  Thread.sleep(4000);
  exportClient.work();
  localServer.shutdown();
  cluster.shutDown();
}
