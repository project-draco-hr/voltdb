{
  System.out.println("testRejoinDataTransfer");
  VoltProjectBuilder builder=getBuilderForTest();
  builder.setSecurityEnabled(true);
  LocalCluster cluster=new LocalCluster("rejoin.jar",2,3,1,BackendTarget.NATIVE_EE_JNI,false,m_useIv2);
  cluster.overrideAnyRequestForValgrind();
  cluster.setMaxHeap(256);
  boolean success=cluster.compile(builder);
  assertTrue(success);
  MiscUtils.copyFile(builder.getPathToDeployment(),Configuration.getPathToCatalogForTest("rejoin.xml"));
  cluster.setHasLocalServer(false);
  cluster.startUp();
  ClientResponse response;
  Client client;
  client=ClientFactory.createClient(m_cconfig);
  client.createConnection("localhost",cluster.port(0));
  response=client.callProcedure("InsertSinglePartition",0);
  assertEquals(ClientResponse.SUCCESS,response.getStatus());
  response=client.callProcedure("Insert",1);
  assertEquals(ClientResponse.SUCCESS,response.getStatus());
  response=client.callProcedure("InsertReplicated",0);
  assertEquals(ClientResponse.SUCCESS,response.getStatus());
  cluster.shutDownSingleHost(0);
  Thread.sleep(1000);
  VoltDB.Configuration config=new VoltDB.Configuration(cluster.portGenerator);
  config.m_enableIV2=m_useIv2;
  config.m_startAction=START_ACTION.REJOIN;
  config.m_pathToCatalog=Configuration.getPathToCatalogForTest("rejoin.jar");
  config.m_pathToDeployment=Configuration.getPathToCatalogForTest("rejoin.xml");
  config.m_leader=":" + cluster.internalPort(1);
  config.m_isRejoinTest=true;
  cluster.setPortsFromConfig(0,config);
  ServerThread localServer=new ServerThread(config);
  localServer.start();
  localServer.waitForRejoin();
  Thread.sleep(2000);
  client.close();
  client=ClientFactory.createClient(m_cconfig);
  client.createConnection("localhost",cluster.port(1));
  response=client.callProcedure("SelectBlahSinglePartition",0);
  assertEquals(ClientResponse.SUCCESS,response.getStatus());
  assertEquals(response.getResults()[0].fetchRow(0).getLong(0),0);
  response=client.callProcedure("SelectBlah",1);
  assertEquals(ClientResponse.SUCCESS,response.getStatus());
  assertEquals(response.getResults()[0].fetchRow(0).getLong(0),1);
  response=client.callProcedure("SelectBlahReplicated",0);
  assertEquals(ClientResponse.SUCCESS,response.getStatus());
  assertEquals(response.getResults()[0].fetchRow(0).getLong(0),0);
  response=client.callProcedure("InsertSinglePartition",2);
  assertEquals(ClientResponse.SUCCESS,response.getStatus());
  response=client.callProcedure("Insert",3);
  assertEquals(ClientResponse.SUCCESS,response.getStatus());
  response=client.callProcedure("InsertReplicated",1);
  assertEquals(ClientResponse.SUCCESS,response.getStatus());
  response=client.callProcedure("SelectBlahSinglePartition",2);
  assertEquals(ClientResponse.SUCCESS,response.getStatus());
  assertEquals(response.getResults()[0].fetchRow(0).getLong(0),2);
  response=client.callProcedure("SelectBlah",3);
  assertEquals(ClientResponse.SUCCESS,response.getStatus());
  assertEquals(response.getResults()[0].fetchRow(0).getLong(0),3);
  response=client.callProcedure("SelectBlahReplicated",1);
  assertEquals(ClientResponse.SUCCESS,response.getStatus());
  assertEquals(response.getResults()[0].fetchRow(0).getLong(0),1);
  cluster.shutDownSingleHost(1);
  Thread.sleep(1000);
  client.close();
  client=ClientFactory.createClient(m_cconfig);
  client.createConnection("localhost",cluster.port(0));
  response=client.callProcedure("SelectBlahSinglePartition",2);
  assertEquals(ClientResponse.SUCCESS,response.getStatus());
  assertEquals(response.getResults()[0].fetchRow(0).getLong(0),2);
  response=client.callProcedure("SelectBlah",3);
  assertEquals(ClientResponse.SUCCESS,response.getStatus());
  assertEquals(response.getResults()[0].fetchRow(0).getLong(0),3);
  response=client.callProcedure("SelectBlahReplicated",1);
  assertEquals(ClientResponse.SUCCESS,response.getStatus());
  assertEquals(response.getResults()[0].fetchRow(0).getLong(0),1);
  client.close();
  localServer.shutdown();
  cluster.shutDown();
}
