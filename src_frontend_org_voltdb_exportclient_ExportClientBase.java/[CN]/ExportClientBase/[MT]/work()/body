{
  int offeredMsgs=0;
  preWorkHook();
  m_atomicWorkLock.lock();
  try {
    startWorkHook();
    assert(m_connected.get());
    for (    HashMap<String,HashMap<Integer,ExportDataSink>> gen_map : m_sinks.values()) {
      for (      HashMap<Integer,ExportDataSink> part_map : gen_map.values()) {
        for (        ExportDataSink sink : part_map.values()) {
          sink.work();
        }
      }
    }
    for (    ExportConnection connection : m_exportConnections.values()) {
      offeredMsgs+=connection.work();
    }
    if (!checkConnections()) {
      disconnect();
      throw new ExportClientException(ExportClientException.Type.DISCONNECT_UNEXPECTED,"Disconnected from one or more export servers");
    }
    endWorkHook();
  }
  finally {
    m_atomicWorkLock.unlock();
  }
  return offeredMsgs;
}
