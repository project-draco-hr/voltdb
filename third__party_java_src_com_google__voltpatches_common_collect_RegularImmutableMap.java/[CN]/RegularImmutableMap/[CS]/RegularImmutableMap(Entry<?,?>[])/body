{
  int size=theEntries.length;
  entries=createEntryArray(size);
  int tableSize=Hashing.closedTableSize(size,MAX_LOAD_FACTOR);
  table=createEntryArray(tableSize);
  mask=tableSize - 1;
  for (int entryIndex=0; entryIndex < size; entryIndex++) {
    @SuppressWarnings("unchecked") Entry<K,V> entry=(Entry<K,V>)theEntries[entryIndex];
    K key=entry.getKey();
    V value=entry.getValue();
    checkEntryNotNull(key,value);
    int tableIndex=Hashing.smear(key.hashCode()) & mask;
    @Nullable ImmutableMapEntry<K,V> existing=table[tableIndex];
    ImmutableMapEntry<K,V> newEntry=(existing == null) ? new TerminalEntry<K,V>(key,value) : new NonTerminalMapEntry<K,V>(key,value,existing);
    table[tableIndex]=newEntry;
    entries[entryIndex]=newEntry;
    checkNoConflictInBucket(key,newEntry,existing);
  }
}
