{
  File f=new File(TEMPDH,System.getProperty("user.name"));
  if (!f.exists() && !f.mkdirs()) {
    throw new SetUpException("Failed to create required OSGI cache directory: " + f.getAbsolutePath());
  }
  if (!f.isDirectory() || !f.canRead() || !f.canWrite()|| !f.canExecute()) {
    throw new SetUpException("Cannot access OSGI cache directory: " + f.getAbsolutePath());
  }
  String systemPackagesSpec=FluentIterable.from(SYSTEM_PACKAGES).transform(appendVersion).join(COMMA_JOINER);
  Map<String,String> frameworkProps=ImmutableMap.<String,String>builder().put(Constants.FRAMEWORK_SYSTEMPACKAGES_EXTRA,systemPackagesSpec).put("org.osgi.framework.storage.clean","onFirstInit").put("felix.cache.rootdir",f.getAbsolutePath()).put("felix.cache.locking",Boolean.FALSE.toString()).build();
  LOG.info("Framework properties are: " + frameworkProps);
  FrameworkFactory frameworkFactory=ServiceLoader.load(FrameworkFactory.class).iterator().next();
  m_framework=frameworkFactory.newFramework(frameworkProps);
  try {
    m_framework.start();
  }
 catch (  BundleException e) {
    LOG.error("Failed to start the felix OSGi framework",e);
    throw new SetUpException("Failed to start the felix OSGi framework",e);
  }
  m_bundles=new BundleRef(m_framework);
}
