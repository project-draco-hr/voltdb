{
  setState(State.SNAPSHOTTING);
  m_lastSysprocInvocation=now;
  final Date nowDate=new Date(now);
  final String dateString=m_dateFormat.format(nowDate);
  final String nonce=m_prefix + dateString;
  JSONObject jsObj=new JSONObject();
  try {
    jsObj.put("path",m_path);
    jsObj.put("nonce",nonce);
    jsObj.put("perPartitionTxnIds",retrievePerPartitionTransactionIds());
    m_snapshots.offer(new Snapshot(m_path,nonce,now));
    long handle=m_nextCallbackHandle++;
    m_procedureCallbacks.put(handle,new ProcedureCallback(){
      @Override public void clientCallback(      final ClientResponse clientResponse) throws Exception {
        processClientResponsePrivate(clientResponse);
      }
    }
);
    m_initiator.initiateSnapshotDaemonWork("@SnapshotSave",handle,new Object[]{jsObj.toString(4)});
  }
 catch (  JSONException e) {
    VoltDB.crashLocalVoltDB("",false,e);
  }
}
