{
  m_recoveryLog.info("Shipping ZK snapshot from " + m_siteId + " to "+ faultedInitiator);
  ByteArrayOutputStream baos=new ByteArrayOutputStream();
  Deflater deflater=new Deflater(Deflater.BEST_COMPRESSION);
  DeflaterOutputStream defos=new DeflaterOutputStream(baos,deflater);
  DataOutputStream dos=new DataOutputStream(defos);
  BinaryOutputArchive boa=new BinaryOutputArchive(dos);
  m_server.getZKDatabase().serializeSnapshot(boa);
  dos.flush();
  defos.finish();
  byte databaseBytes[]=CompressionService.compressBytes(baos.toByteArray());
  ByteBuffer metadata=ByteBuffer.allocate(8);
  metadata.putLong(txnId);
  BinaryPayloadMessage bpm=new BinaryPayloadMessage(metadata.array(),databaseBytes);
  try {
    m_mailbox.send(faultedInitiator,VoltDB.AGREEMENT_MAILBOX_ID,bpm);
  }
 catch (  MessagingException e) {
    throw new IOException(e);
  }
  m_siteRequestingRecovery=null;
  m_recoverBeforeTxn=null;
}
