{
  ByteBuffer responseBuffer=ByteBuffer.allocate(30);
  responseBuffer.putInt(26);
  responseBuffer.put((byte)0);
  socket.configureBlocking(false);
  socket.socket().setTcpNoDelay(true);
  final ByteBuffer lengthBuffer=ByteBuffer.allocate(4);
  for (int ii=0; ii < 4; ii++) {
    socket.read(lengthBuffer);
    if (!lengthBuffer.hasRemaining()) {
      break;
    }
    try {
      Thread.sleep(400);
    }
 catch (    InterruptedException e) {
      throw new IOException(e);
    }
  }
  if (lengthBuffer.hasRemaining()) {
    responseBuffer.put((byte)2).flip();
    socket.write(responseBuffer);
    socket.close();
    authLog.warn("Failure to authenticate connection(" + socket.socket().getRemoteSocketAddress() + "): wire protocol violation (timeout reading message length).");
    return null;
  }
  lengthBuffer.flip();
  final ByteBuffer message=ByteBuffer.allocate(lengthBuffer.getInt());
  for (int ii=0; ii < 4; ii++) {
    socket.read(message);
    if (!message.hasRemaining()) {
      break;
    }
    try {
      Thread.sleep(20);
    }
 catch (    InterruptedException e) {
      throw new IOException(e);
    }
  }
  if (lengthBuffer.hasRemaining()) {
    responseBuffer.put((byte)2).flip();
    socket.write(responseBuffer);
    socket.close();
    authLog.warn("Failure to authenticate connection(" + socket.socket().getRemoteSocketAddress() + "): wire protocol violation (timeout reading authentication strings).");
    return null;
  }
  message.flip().position(1);
  FastDeserializer fds=new FastDeserializer(message);
  final String username=fds.readString();
  final byte password[]=new byte[20];
  message.get(password);
  final AuthSystem.AuthUser user=m_catalogContext.get().authSystem.authenticate(username,password);
  ClientInputHandler handler=null;
  if (user == null) {
    responseBuffer.put((byte)-1).flip();
    socket.write(responseBuffer);
    socket.close();
    authLog.warn("Failure to authenticate connection(" + socket.socket().getRemoteSocketAddress() + "): user "+ username+ " failed authentication.");
    return null;
  }
 else {
    handler=new ClientInputHandler(user,socket.socket().getInetAddress().getHostName());
    responseBuffer.put((byte)0);
    responseBuffer.putInt(VoltDB.instance().getHostMessenger().getHostId());
    responseBuffer.putLong(handler.connectionId());
    responseBuffer.putLong((Long)VoltDB.instance().getInstanceId()[0]);
    responseBuffer.putInt((Integer)VoltDB.instance().getInstanceId()[1]).flip();
    socket.write(responseBuffer);
  }
  return handler;
}
