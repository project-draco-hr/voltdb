{
  try {
    do {
      final SocketChannel socket=m_serverSocket.accept();
      if (m_numConnections.get() == MAX_CONNECTIONS) {
        networkLog.warn("Rejected connection from " + socket.socket().getRemoteSocketAddress() + " because the connection limit of "+ MAX_CONNECTIONS+ " has been reached");
        final ByteBuffer b=ByteBuffer.allocate(1);
        b.put((byte)1);
        b.flip();
        socket.configureBlocking(true);
        for (int ii=0; ii < 4 && b.hasRemaining(); ii++) {
          socket.write(b);
        }
        socket.close();
        continue;
      }
      m_numConnections.incrementAndGet();
      m_executor.submit(new Runnable(){
        @Override public void run(){
          if (socket != null) {
            boolean success=false;
            try {
              final AuthSystem.AuthUser user=authenticate(socket);
              if (user != null) {
                socket.configureBlocking(false);
                socket.socket().setTcpNoDelay(false);
                socket.socket().setKeepAlive(true);
                ClientInputHandler handler=new ClientInputHandler(user);
synchronized (m_connections) {
                  Connection c=null;
                  if (m_hasDTXNBackPressure) {
                    c=m_network.registerChannel(socket,handler,0);
                  }
 else {
                    c=m_network.registerChannel(socket,handler,SelectionKey.OP_READ);
                  }
                  m_connections.add(c);
                }
                success=true;
              }
            }
 catch (            IOException e) {
              try {
                socket.close();
              }
 catch (              IOException e1) {
              }
              if (m_running) {
                hostLog.warn("Exception authenticating and registering user in ClientAcceptor",e);
              }
            }
 finally {
              if (!success) {
                m_numConnections.decrementAndGet();
              }
            }
          }
        }
      }
);
    }
 while (m_running);
  }
 catch (  IOException e) {
    if (m_running) {
      hostLog.fatal("Exception in ClientAcceptor. The acceptor has died",e);
    }
  }
 finally {
    try {
      m_serverSocket.close();
    }
 catch (    IOException e) {
      hostLog.fatal(null,e);
    }
synchronized (this) {
      Thread.interrupted();
      m_executor.shutdownNow();
      try {
        m_executor.awaitTermination(1,TimeUnit.DAYS);
      }
 catch (      InterruptedException e) {
        throw new RuntimeException(e);
      }
    }
  }
}
