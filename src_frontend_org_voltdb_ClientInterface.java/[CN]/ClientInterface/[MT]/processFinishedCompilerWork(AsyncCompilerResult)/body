{
  final Connection c=(Connection)result.clientData;
  final ListenableFutureTask<?> ft=ListenableFutureTask.create(new Runnable(){
    @Override public void run(){
      if (result.errorMsg == null) {
        if (result instanceof AdHocPlannedStmtBatch) {
          final AdHocPlannedStmtBatch plannedStmtBatch=(AdHocPlannedStmtBatch)result;
          if ((plannedStmtBatch.getPlannedStatementCount() > 0) && (plannedStmtBatch.getPlannedStatement(0).core.catalogVersion != m_catalogContext.get().catalogVersion)) {
            LocalObjectMessage work=new LocalObjectMessage(AdHocPlannerWork.rework(plannedStmtBatch.work,m_adhocCompletionHandler));
            m_mailbox.send(m_plannerSiteId,work);
          }
 else           if (plannedStmtBatch.isExplainWork()) {
            processExplainPlannedStmtBatch(plannedStmtBatch);
          }
 else {
            try {
              createAdHocTransaction(plannedStmtBatch);
            }
 catch (            VoltTypeException vte) {
              Object partitionParam=plannedStmtBatch.partitionParam();
              String msg="Unable to hash the partition for adhoc partition value: " + (partitionParam == null ? "null" : partitionParam.toString()) + ", msg: "+ vte.getMessage();
              ClientResponseImpl errorResponse=new ClientResponseImpl(ClientResponseImpl.GRACEFUL_FAILURE,new VoltTable[0],msg,result.clientHandle);
              ByteBuffer buf=ByteBuffer.allocate(errorResponse.getSerializedSize() + 4);
              buf.putInt(buf.capacity() - 4);
              errorResponse.flattenToBuffer(buf);
              buf.flip();
              c.writeStream().enqueue(buf);
            }
          }
        }
 else         if (result instanceof CatalogChangeResult) {
          final CatalogChangeResult changeResult=(CatalogChangeResult)result;
          if (changeResult.encodedDiffCommands.trim().length() == 0) {
            ClientResponseImpl shortcutResponse=new ClientResponseImpl(ClientResponseImpl.SUCCESS,new VoltTable[0],"Catalog update with no changes was skipped.",result.clientHandle);
            ByteBuffer buf=ByteBuffer.allocate(shortcutResponse.getSerializedSize() + 4);
            buf.putInt(buf.capacity() - 4);
            shortcutResponse.flattenToBuffer(buf);
            buf.flip();
            c.writeStream().enqueue(buf);
          }
 else {
            StoredProcedureInvocation task=new StoredProcedureInvocation();
            task.procName="@UpdateApplicationCatalog";
            task.setParams(changeResult.encodedDiffCommands,changeResult.catalogHash,changeResult.catalogBytes,changeResult.expectedCatalogVersion,changeResult.deploymentString,changeResult.deploymentCRC,changeResult.requiresSnapshotIsolation ? 1 : 0);
            task.clientHandle=changeResult.clientHandle;
            task.type=changeResult.invocationType;
            task.originalTxnId=changeResult.originalTxnId;
            task.originalUniqueId=changeResult.originalUniqueId;
            FastSerializer fs=new FastSerializer();
            try {
              fs.writeObject(task);
              ByteBuffer source=fs.getBuffer();
              ByteBuffer copy=ByteBuffer.allocate(source.remaining());
              copy.put(source);
              copy.flip();
              FastDeserializer fds=new FastDeserializer(copy);
              task=new StoredProcedureInvocation();
              task.readExternal(fds);
            }
 catch (            Exception e) {
              hostLog.fatal(e);
              VoltDB.crashLocalVoltDB(e.getMessage(),true,e);
            }
            createTransaction(changeResult.connectionId,task,false,false,false,0,task.getSerializedSize(),EstTime.currentTimeMillis());
          }
        }
 else {
          throw new RuntimeException("Should not be able to get here (ClientInterface.checkForFinishedCompilerWork())");
        }
      }
 else {
        ClientResponseImpl errorResponse=new ClientResponseImpl(ClientResponseImpl.GRACEFUL_FAILURE,new VoltTable[0],result.errorMsg,result.clientHandle);
        ByteBuffer buf=ByteBuffer.allocate(errorResponse.getSerializedSize() + 4);
        buf.putInt(buf.capacity() - 4);
        errorResponse.flattenToBuffer(buf);
        buf.flip();
        c.writeStream().enqueue(buf);
      }
    }
  }
,null);
  if (c != null) {
    c.queueTask(ft);
  }
  ft.addListener(new Runnable(){
    @Override public void run(){
      try {
        ft.get();
      }
 catch (      Exception e) {
        String realReason=result.errorMsg;
        if (realReason == null) {
          StringWriter sw=new StringWriter();
          PrintWriter pw=new PrintWriter(sw);
          e.printStackTrace(pw);
          Throwable cause=e.getCause();
          if (cause != null) {
            cause.printStackTrace(pw);
          }
          pw.flush();
          realReason=sw.toString();
        }
        ClientResponseImpl errorResponse=new ClientResponseImpl(ClientResponseImpl.UNEXPECTED_FAILURE,new VoltTable[0],realReason,result.clientHandle);
        ByteBuffer buf=ByteBuffer.allocate(errorResponse.getSerializedSize() + 4);
        buf.putInt(buf.capacity() - 4);
        errorResponse.flattenToBuffer(buf);
        buf.flip();
        c.writeStream().enqueue(buf);
      }
    }
  }
,MoreExecutors.sameThreadExecutor());
  return ft;
}
