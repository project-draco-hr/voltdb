{
  StoredProcedureInvocation task=new StoredProcedureInvocation();
  boolean isSinglePartition=(plannedStmt.partitionParam != null);
  int partitions[]=null;
  if (isSinglePartition && !m_isConfiguredForHSQL) {
    task.procName="@AdHocSP";
    partitions=new int[]{TheHashinator.hashToPartition(plannedStmt.partitionParam)};
  }
 else {
    task.procName="@AdHoc";
    partitions=m_allPartitions;
  }
  task.setParams(plannedStmt.aggregatorFragment,plannedStmt.collectorFragment,plannedStmt.sql,plannedStmt.isReplicatedTableDML ? 1 : 0);
  task.clientHandle=plannedStmt.clientHandle;
  FastSerializer fs=new FastSerializer();
  try {
    fs.writeObject(task);
    ByteBuffer source=fs.getBuffer();
    ByteBuffer copy=ByteBuffer.allocate(source.remaining());
    copy.put(source);
    copy.flip();
    FastDeserializer fds=new FastDeserializer(copy);
    task=new StoredProcedureInvocation();
    task.readExternal(fds);
  }
 catch (  Exception e) {
    VoltDB.crashLocalVoltDB(e.getMessage(),true,e);
  }
  createTransaction(plannedStmt.connectionId,plannedStmt.hostname,plannedStmt.adminConnection,task,false,(isSinglePartition && !m_isConfiguredForHSQL),false,partitions,partitions.length,plannedStmt.clientData,0,EstTime.currentTimeMillis());
  plannedStmt.clientData=null;
  m_adhocCache.put(plannedStmt);
}
