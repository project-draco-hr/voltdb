{
  Preconditions.checkArgument(oldHashinator instanceof ElasticHashinator);
  ElasticHashinator oldElasticHashinator=(ElasticHashinator)oldHashinator;
  Random r=new Random(0);
  Map<Long,Integer> newConfig=new HashMap<Long,Integer>(oldElasticHashinator.tokens);
  Set<Integer> existingPartitions=new HashSet<Integer>(oldElasticHashinator.tokens.values());
  Set<Long> checkSet=new HashSet<Long>(oldElasticHashinator.tokens.keySet());
  for (  int pid : newPartitions) {
    if (existingPartitions.contains(pid)) {
      throw new RuntimeException("Partition " + pid + " already exists in the "+ "hashinator");
    }
    for (int i=0; i < tokensPerPartition; i++) {
      while (true) {
        long candidateToken=MurmurHash3.hash3_x64_128(r.nextLong());
        if (!checkSet.add(candidateToken)) {
          continue;
        }
        newConfig.put(candidateToken,pid);
        break;
      }
    }
  }
  return new ElasticHashinator(newConfig).toBytes();
}
