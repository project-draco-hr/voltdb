{
  Preconditions.checkArgument(oldHashinator instanceof ElasticHashinator);
  ElasticHashinator oldElasticHashinator=(ElasticHashinator)oldHashinator;
  Map<Long,Integer> newConfig=new HashMap<Long,Integer>(oldElasticHashinator.tokens);
  Set<Integer> existingPartitions=new HashSet<Integer>(oldElasticHashinator.tokens.values());
  for (  Map.Entry<Long,Integer> entry : tokensToPartitions.entrySet()) {
    long token=entry.getKey();
    int pid=entry.getValue();
    if (existingPartitions.contains(pid)) {
      throw new RuntimeException("Partition " + pid + " already exists in the "+ "hashinator");
    }
    Integer oldPartition=newConfig.put(token,pid);
    if (oldPartition != null) {
      throw new RuntimeException("Token " + token + " used to map to partition "+ oldPartition+ " but now maps to "+ pid);
    }
  }
  return new ElasticHashinator(newConfig).toBytes();
}
