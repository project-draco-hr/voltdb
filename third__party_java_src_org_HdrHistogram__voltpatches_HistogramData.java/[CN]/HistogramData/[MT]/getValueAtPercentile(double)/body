{
  double requestedPercentile=Math.min(percentile,100.0);
  long countAtPercentile=(long)(((requestedPercentile / 100.0) * getTotalCount()) + 0.5);
  countAtPercentile=Math.max(countAtPercentile,1);
  long totalToCurrentIJ=0;
  for (int i=0; i < bucketCount; i++) {
    int j=(i == 0) ? 0 : (subBucketCount / 2);
    for (; j < subBucketCount; j++) {
      totalToCurrentIJ+=histogram.getCountAt(i,j);
      if (totalToCurrentIJ >= countAtPercentile) {
        long valueAtIndex=valueFromIndex(i,j,histogram.unitMagnitude);
        return valueAtIndex;
      }
    }
  }
  throw new ArrayIndexOutOfBoundsException("percentile value not found in range");
}
