{
  ArrayDeque<BBContainer[]> buffersToPush=new ArrayDeque<BBContainer[]>();
  Iterator<StreamBlock> iter=m_memoryDeque.descendingIterator();
  while (iter.hasNext()) {
    StreamBlock sb=iter.next();
    if (sb.isPersisted()) {
      break;
    }
    buffersToPush.push(sb.asBufferChain());
    iter.remove();
  }
  m_memoryDeque.clear();
  if (!buffersToPush.isEmpty()) {
    m_persistentDeque.push(buffersToPush.toArray(new BBContainer[0][0]));
  }
  if (!nofsync) {
    m_persistentDeque.sync();
  }
}
