from optparse import OptionParser
from datetime import date, datetime, timedelta
import getpass
import os
import re
from subprocess import Popen
import subprocess
import sys
import jiratools
exclusions = []
jira_url = 'https://issues.voltdb.com/'
if (__name__ == '__main__'):
    delete = False
    current_branch = get_current_branch()
    if (current_branch != 'master'):
        sys.exit(('You must be on master. Your current branch is %s.' % current_branch))
    parser = OptionParser()
    parser.add_option('-u', '--username', dest='username', action='store', help='username to use for Jira lookups', default=getpass.getuser())
    parser.add_option('-p', '--password', dest='password', action='store', help='password to use for Jira lookups')
    parser.add_option('--no-merged', dest='merged', action='store_false', help='find branches that are not merged to master', default=True)
    parser.add_option('--older', dest='olderthan', action='store', help='age of unmerged branches to list', default=21)
    (options, args) = parser.parse_args()
    user = options.username
    password = (options.password or getpass.getpass('Enter your Jira password: '))
    print ('# Branches with checkins within %d days will not be listed' % options.olderthan)
    branch_list = get_branch_list(options.merged)
    if options.merged:
        make_delete_branches_script(branch_list, True)
    else:
        old_branches = weed_out_newer_branches(branch_list, options.olderthan)
        make_archive_branches_script(old_branches)
        print "\n#----------------\n#Don't forget to git push --tags\n#----------------"
