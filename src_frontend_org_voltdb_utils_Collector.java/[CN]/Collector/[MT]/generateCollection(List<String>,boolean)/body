{
  try {
    String timestamp="";
    String rootpath="";
    if (copyToVEM) {
      rootpath=m_config.voltdbroot;
    }
 else {
      TimestampType ts=new TimestampType(new java.util.Date());
      timestamp=ts.toString().replace(' ','-').replace(':','-');
      timestamp=timestamp.substring(0,"YYYY-mm-DD-HH-MM-ss".length());
      rootpath=System.getProperty("user.dir");
    }
    String collectionFilePath=rootpath + File.separator + m_config.prefix+ timestamp+ ".tgz";
    File collectionFile=new File(collectionFilePath);
    TarGenerator tarGenerator=new TarGenerator(collectionFile,true,null);
    String folderPath=m_config.prefix + timestamp + File.separator;
    for (    String path : paths) {
      if (Arrays.asList(cmdFilenames).contains(path.split(" ")[0])) {
        continue;
      }
      File file=new File(path);
      String filename=file.getName();
      String entryPath=file.getName();
      for (      String logPath : m_logPaths) {
        if (filename.startsWith(new File(logPath).getName())) {
          entryPath="log" + File.separator + file.getName();
          break;
        }
      }
      if (filename.startsWith("voltdb_crash")) {
        entryPath="voltdb_crash" + File.separator + file.getName();
      }
      if (filename.startsWith("syslog") || filename.equals("dmesg")) {
        entryPath="syslog" + File.separator + file.getName();
      }
      if (file.isFile() && file.canRead() && file.length() > 0) {
        tarGenerator.queueEntry(folderPath + entryPath,file);
      }
    }
    String[] sarCmd={"bash","-c","sar -A"};
    cmd(tarGenerator,sarCmd,folderPath,"sardata");
    String[] dmesgCmd={"bash","-c","/bin/dmesg"};
    cmd(tarGenerator,dmesgCmd,folderPath,"dmesgdata");
    tarGenerator.write(m_config.calledFromVEM ? null : System.out);
    long sizeInByte=collectionFile.length();
    String sizeStringInKB=String.format("%5.2f",(double)sizeInByte / 1000);
    if (!m_config.calledFromVEM) {
      System.out.println("Collection file created at " + collectionFilePath + " size: "+ sizeStringInKB+ " KB");
    }
    boolean upload=false;
    if (!m_config.host.isEmpty()) {
      if (m_config.noprompt) {
        upload=true;
      }
 else {
        upload=getUserResponse("Upload via SFTP");
      }
    }
    if (upload) {
      if (org.voltdb.utils.MiscUtils.isPro()) {
        if (m_config.username.isEmpty() && !m_config.noprompt) {
          System.out.print("username: ");
          m_config.username=System.console().readLine();
        }
        if (m_config.password.isEmpty() && !m_config.noprompt) {
          System.out.print("password: ");
          m_config.password=new String(System.console().readPassword());
        }
        try {
          uploadToServer(collectionFilePath,m_config.host,m_config.username,m_config.password);
          System.out.println("Uploaded " + new File(collectionFilePath).getName() + " via SFTP");
          boolean delLocalCopy=false;
          if (m_config.noprompt) {
            delLocalCopy=true;
          }
 else {
            delLocalCopy=getUserResponse("Delete local copy " + collectionFilePath);
          }
          if (delLocalCopy) {
            try {
              collectionFile.delete();
              if (!m_config.calledFromVEM) {
                System.out.println("Local copy " + collectionFilePath + " deleted");
              }
            }
 catch (            SecurityException e) {
              System.err.println("Failed to delete local copy " + collectionFilePath + ". "+ e.getMessage());
            }
          }
        }
 catch (        Exception e) {
          System.err.println(e.getMessage());
        }
      }
 else {
        System.out.println("Uploading is only available in the Enterprise Edition");
      }
    }
  }
 catch (  Exception e) {
    System.err.println(e.getMessage());
  }
}
