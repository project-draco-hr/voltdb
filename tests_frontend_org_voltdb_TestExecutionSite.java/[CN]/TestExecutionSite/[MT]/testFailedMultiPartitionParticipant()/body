{
  tearDown();
  start(2,2,0);
  final boolean readOnly=false, singlePartition=false;
  Thread es1;
  final StoredProcedureInvocation tx1_spi=new StoredProcedureInvocation();
  tx1_spi.setProcName("org.voltdb.TestExecutionSite$MockMPVoltProcedure");
  tx1_spi.setParams("commit",new Integer(0));
  final InitiateTaskMessage tx1_mn_1=new InitiateTaskMessage(getInitiatorIdForSiteId(0),0,DtxnConstants.DUMMY_LAST_SEEN_TXN_ID,readOnly,singlePartition,tx1_spi,Long.MAX_VALUE,new long[]{getHSIdForES(1)});
  final long siteId0=getHSIdForES(0);
  final Mailbox m0=m_mboxes.get(siteId0);
  final ExecutionSite es0=m_sites.get(siteId0);
  es0.lastKnownGloballyCommitedMultiPartTxnId=DtxnConstants.DUMMY_LAST_SEEN_TXN_ID + 1;
  final MultiPartitionParticipantTxnState tx1_1=new MultiPartitionParticipantTxnState(m0,es0,tx1_mn_1);
  int callcheck=MockMPProcedureRunner.m_called;
  assertFalse(tx1_1.isDone());
  es0.m_transactionsById.put(tx1_1.txnId,tx1_1);
  es1=new Thread(new Runnable(){
    @Override public void run(){
      es0.recursableRun(tx1_1);
    }
  }
);
  es1.start();
  m_voltdb.killSite(getHSIdForES(1));
  m_voltdb.killSite(getInitiatorIds()[1]);
  m_voltdb.getFaultDistributor().reportFault(new SiteFailureFault(Arrays.asList(new Long[]{getInitiatorIds()[1],getHSIdForES(1)})));
  es1.join();
  assertTrue(tx1_1.isDone());
  assertFalse(tx1_1.needsRollback());
  assertEquals(null,es0.m_transactionsById.get(tx1_1.txnId));
  assertEquals((++callcheck),MockMPProcedureRunner.m_called);
}
