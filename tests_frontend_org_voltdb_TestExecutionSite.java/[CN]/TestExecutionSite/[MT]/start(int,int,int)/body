{
  long seed=System.currentTimeMillis();
  m_rand=new Random(seed);
  m_checker=new ExecutionSiteFuzzChecker();
  m_voltdb=new MockVoltDB();
  m_voltdb.setFaultDistributor(new FaultDistributor(m_voltdb));
  for (int ss=0; ss < siteCount; ss++) {
    final long siteId=CoreUtils.getHSIdFromHostAndSite(getHostIdForSiteId(ss),getInitiatorIdForSiteId(ss));
    m_voltdb.addSite(siteId,MailboxType.Initiator);
    String logname=ExecutionSite.class.getName() + "." + ss;
    final VoltLogger siteLogger=new VoltLogger(logname);
    m_siteLogger.put(siteId,siteLogger);
    final StringWriter siteResults=new StringWriter();
    m_siteResults.put(siteId,siteResults);
    siteLogger.addSimpleWriterAppender(siteResults);
    siteLogger.setLevel(Level.TRACE);
  }
  int siteIndex=0;
  for (int pp=0; pp < partitionCount; pp++) {
    for (int kk=0; kk < (kFactor + 1); kk++) {
      final long siteId=CoreUtils.getHSIdFromHostAndSite(getHostIdForSiteId(siteIndex),siteIndex);
      m_voltdb.addSite(siteId,pp);
      m_checker.addSite(siteId,pp,m_siteResults.get(CoreUtils.getHSIdFromHostAndSite(siteIndex,getInitiatorIdForSiteId(siteIndex))));
      ++siteIndex;
    }
  }
  if (siteIndex != siteCount) {
    throw new RuntimeException("Invalid setup logic.");
  }
  Procedure proc=null;
  proc=m_voltdb.addProcedureForTest(MockSPVoltProcedure.class.getName());
  proc.setReadonly(false);
  proc.setSinglepartition(true);
  proc=m_voltdb.addProcedureForTest(MockROSPVoltProcedure.class.getName());
  proc.setReadonly(true);
  proc.setSinglepartition(true);
  proc=m_voltdb.addProcedureForTest(MockMPVoltProcedure.class.getName());
  proc.setReadonly(false);
  proc.setSinglepartition(false);
  proc=m_voltdb.addProcedureForTest(MockMPVoltProcedureRollbackParticipant.class.getName());
  proc.setReadonly(false);
  proc.setSinglepartition(false);
  VoltDB.replaceVoltDBInstanceForTest(m_voltdb);
  for (int ss=0; ss < siteCount; ++ss) {
    long siteId=CoreUtils.getHSIdFromHostAndSite(ss,ss);
    m_mboxes.put(siteId,new RussianRouletteMailbox(siteId));
    m_siteLogger.put(siteId,m_siteLogger.get(CoreUtils.getHSIdFromHostAndSite(ss,getInitiatorIdForSiteId(ss))));
    m_rpqs.put(siteId,new RestrictedPriorityARRR(getInitiatorIds(),ss,m_mboxes.get(siteId)));
    m_sites.put(siteId,new ExecutionSite(m_voltdb,m_mboxes.get(siteId),null,m_rpqs.get(siteId),new MockProcedureRunnerFactory(),false,false,0,partitionCount));
    registerMailbox(siteId,m_mboxes.get(siteId));
  }
}
