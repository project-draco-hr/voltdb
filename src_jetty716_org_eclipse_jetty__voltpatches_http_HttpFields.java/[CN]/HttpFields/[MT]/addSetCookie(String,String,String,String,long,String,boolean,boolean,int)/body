{
  String delim=_maxCookieVersion == 0 ? "" : "\"\\\n\r\t\f\b%+ ;=";
  if (name == null || name.length() == 0)   throw new IllegalArgumentException("Bad cookie name");
  StringBuilder buf=new StringBuilder(128);
  String name_value_params;
  boolean quoted=QuotedStringTokenizer.quoteIfNeeded(buf,name,delim);
  buf.append('=');
  String start=buf.toString();
  if (value != null && value.length() > 0)   quoted|=QuotedStringTokenizer.quoteIfNeeded(buf,value,delim);
  if (quoted && version == 0 && _maxCookieVersion >= 1)   version=1;
  if (version > _maxCookieVersion)   version=_maxCookieVersion;
  if (version > 0) {
    buf.append(";Version=");
    buf.append(version);
    if (comment != null && comment.length() > 0) {
      buf.append(";Comment=");
      QuotedStringTokenizer.quoteIfNeeded(buf,comment,delim);
    }
  }
  if (path != null && path.length() > 0) {
    buf.append(";Path=");
    if (path.trim().startsWith("\""))     buf.append(path);
 else     QuotedStringTokenizer.quoteIfNeeded(buf,path,delim);
  }
  if (domain != null && domain.length() > 0) {
    buf.append(";Domain=");
    QuotedStringTokenizer.quoteIfNeeded(buf,domain.toLowerCase(),delim);
  }
  if (maxAge >= 0) {
    buf.append(";Expires=");
    if (maxAge == 0)     buf.append(__01Jan1970);
 else     formatCookieDate(buf,System.currentTimeMillis() + 1000L * maxAge);
    if (version > 0) {
      buf.append(";Max-Age=");
      buf.append(maxAge);
    }
  }
 else   if (version > 0) {
    buf.append(";Discard");
  }
  if (isSecure)   buf.append(";Secure");
  if (isHttpOnly)   buf.append(";HttpOnly");
  name_value_params=buf.toString();
  Field field=getField(HttpHeaders.SET_COOKIE_BUFFER);
  if (field != null) {
    final int revision=_revision;
    while (field != null) {
      if (field._revision != revision || field._value != null && field._value.toString().startsWith(start)) {
        field.reset(new ByteArrayBuffer(name_value_params),-1,revision);
        return;
      }
      field=field._next;
    }
  }
  add(HttpHeaders.SET_COOKIE_BUFFER,new ByteArrayBuffer(name_value_params));
  put(HttpHeaders.EXPIRES_BUFFER,__01Jan1970_BUFFER);
}
