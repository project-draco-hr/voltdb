{
  int hostId=siteId / VoltDB.SITES_TO_HOST_DIVISOR;
  int localSiteId=siteId % VoltDB.SITES_TO_HOST_DIVISOR;
  if (hostId == m_localHostId) {
    MessengerSite site=m_messengerSites[localSiteId];
    if (site != null) {
      Mailbox mbox=site.getMailbox(mailboxId);
      if (mbox != null) {
        mbox.deliver(message);
        return null;
      }
    }
  }
  ForeignHost fhost=m_foreignHosts[hostId];
  if (fhost == null) {
    throw new MessagingException("Attempted to send a message to foreign host with id " + hostId + " but there is no such host.");
  }
  if (!fhost.isUp()) {
    Throwable t=new Throwable();
    java.io.StringWriter sw=new java.io.StringWriter();
    java.io.PrintWriter pw=new java.io.PrintWriter(sw);
    t.printStackTrace(pw);
    pw.flush();
    m_logger.warn("Attempted delivery of message to failed site: " + siteId);
    m_logger.warn(sw.toString());
    return null;
  }
  return fhost;
}
