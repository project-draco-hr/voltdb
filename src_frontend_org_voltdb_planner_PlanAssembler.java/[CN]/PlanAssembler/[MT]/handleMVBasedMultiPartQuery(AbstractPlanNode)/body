{
  if (!m_parsedSelect.mvFixInfo.finalNeedFix) {
    return root;
  }
  MVFixInfo mvFixInfo=m_parsedSelect.mvFixInfo;
  AbstractPlanNode scanNode=root;
  while (scanNode instanceof AbstractScanPlanNode == false) {
    scanNode=scanNode.getChild(0);
  }
  ProjectionPlanNode inlineProj=new ProjectionPlanNode();
  inlineProj.setOutputSchema(mvFixInfo.inlineProjSchema);
  scanNode.addInlinePlanNode(inlineProj);
  AggregatePlanNode reAggNode=new HashAggregatePlanNode();
  int outputColumnIndex=0;
  NodeSchema aggSchema=new NodeSchema();
  for (  ParsedSelectStmt.ParsedColInfo col : mvFixInfo.mvAggResultColumns) {
    AbstractExpression rootExpr=col.expression;
    SchemaColumn schema_col=null;
    if (ParsedColInfo.isNewtoColumnList(mvFixInfo.mvDDLGroupbyColumnsList,col)) {
      ExpressionType reAggType=mvFixInfo.mvColumnAggType.get(col.columnName);
      assert(reAggType != null);
      AbstractExpression agg_input_expr=null;
      assert(rootExpr instanceof TupleValueExpression);
      TupleValueExpression tve=new TupleValueExpression();
      tve.setValueType(rootExpr.getValueType());
      tve.setValueSize(rootExpr.getValueSize());
      tve.setColumnIndex(outputColumnIndex);
      tve.setColumnName(col.columnName);
      tve.setColumnAlias(col.alias);
      tve.setTableName(col.tableName);
      agg_input_expr=(AbstractExpression)tve.clone();
      reAggNode.addAggregate(reAggType,false,outputColumnIndex,agg_input_expr);
      schema_col=new SchemaColumn(col.tableName,col.columnName,col.alias,tve);
    }
 else {
      schema_col=new SchemaColumn(col.tableName,col.columnName,col.alias,col.expression);
    }
    aggSchema.addColumn(schema_col);
    outputColumnIndex++;
  }
  reAggNode.setOutputSchema(aggSchema);
  for (  ParsedSelectStmt.ParsedColInfo col : mvFixInfo.mvDDLGroupbyColumnsList) {
    reAggNode.addGroupByExpression(col.expression);
  }
  if (root.getPlanNodeType() == PlanNodeType.RECEIVE) {
    reAggNode.addAndLinkChild(root);
    root=reAggNode;
  }
 else {
    AbstractPlanNode receiveNode=root;
    while (receiveNode.getPlanNodeType() != PlanNodeType.RECEIVE) {
      receiveNode=receiveNode.getChild(0);
    }
    assert(receiveNode.getPlanNodeType() == PlanNodeType.RECEIVE);
    AbstractPlanNode parent=receiveNode.getParent(0);
    receiveNode.clearParents();
    parent.clearChildren();
    reAggNode.addAndLinkChild(receiveNode);
    parent.addAndLinkChild(reAggNode);
  }
  return root;
}
