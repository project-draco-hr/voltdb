{
  boolean containsAggregateExpression=false;
  AggregatePlanNode aggNode=null;
  for (  ParsedSelectStmt.ParsedColInfo col : m_parsedSelect.displayColumns) {
    if (col.expression.hasAnySubexpressionOfClass(AggregateExpression.class)) {
      containsAggregateExpression=true;
      break;
    }
  }
  if (containsAggregateExpression || m_parsedSelect.isGrouped()) {
    AggregatePlanNode topAggNode;
    if (m_parsedSelect.isGrouped() && (root.getPlanNodeType() != PlanNodeType.INDEXSCAN || ((IndexScanPlanNode)root).getSortDirection() == SortDirectionType.INVALID)) {
      aggNode=new HashAggregatePlanNode();
      topAggNode=new HashAggregatePlanNode();
    }
 else {
      aggNode=new AggregatePlanNode();
      topAggNode=new AggregatePlanNode();
    }
    int outputColumnIndex=0;
    NodeSchema agg_schema=new NodeSchema();
    for (    ParsedSelectStmt.ParsedColInfo col : m_parsedSelect.aggResultColumns) {
      AbstractExpression rootExpr=col.expression;
      AbstractExpression agg_input_expr=null;
      SchemaColumn schema_col=null;
      if (rootExpr instanceof AggregateExpression) {
        ExpressionType agg_expression_type=rootExpr.getExpressionType();
        agg_input_expr=rootExpr.getLeft();
        TupleValueExpression tve=new TupleValueExpression();
        tve.setValueType(rootExpr.getValueType());
        tve.setValueSize(rootExpr.getValueSize());
        tve.setColumnIndex(outputColumnIndex);
        tve.setColumnName("");
        tve.setColumnAlias(col.alias);
        tve.setTableName("VOLT_TEMP_TABLE");
        boolean is_distinct=((AggregateExpression)rootExpr).isDistinct();
        aggNode.addAggregate(agg_expression_type,is_distinct,outputColumnIndex,agg_input_expr);
        schema_col=new SchemaColumn("VOLT_TEMP_TABLE","",col.alias,tve);
        if (topAggNode != null) {
          ExpressionType top_expression_type=agg_expression_type;
          if (agg_expression_type == ExpressionType.AGGREGATE_COUNT_STAR || agg_expression_type == ExpressionType.AGGREGATE_COUNT || agg_expression_type == ExpressionType.AGGREGATE_SUM) {
            if (is_distinct) {
              topAggNode=null;
            }
 else {
              top_expression_type=ExpressionType.AGGREGATE_SUM;
            }
          }
 else           if (agg_expression_type != ExpressionType.AGGREGATE_MIN && agg_expression_type != ExpressionType.AGGREGATE_MAX) {
            topAggNode=null;
          }
          if (topAggNode != null) {
            topAggNode.addAggregate(top_expression_type,is_distinct,outputColumnIndex,tve);
          }
        }
      }
 else       if (rootExpr.hasAnySubexpressionOfClass(AggregateExpression.class)) {
        throw new PlanningErrorException("Unsupported operation on the result of an aggregate function in a column expression");
      }
 else {
        schema_col=new SchemaColumn(col.tableName,col.columnName,col.alias,col.expression);
      }
      agg_schema.addColumn(schema_col);
      outputColumnIndex++;
    }
    for (    ParsedSelectStmt.ParsedColInfo col : m_parsedSelect.groupByColumns) {
      if (agg_schema.find(col.tableName,col.columnName,col.alias) == null) {
        throw new PlanningErrorException("GROUP BY column " + col.alias + " is not in the display columns."+ " Please specify "+ col.alias+ " as a display column.");
      }
      aggNode.addGroupByExpression(col.expression);
      if (topAggNode != null) {
        topAggNode.addGroupByExpression(col.expression);
      }
    }
    NodeSchema newSchema=m_parsedSelect.evaluatePostAggColumns();
    aggNode.setOutputSchema(agg_schema);
    root=pushDownAggregate(root,aggNode,topAggNode,newSchema);
  }
  if (m_parsedSelect.isGrouped()) {
    if (m_parsedSelect.displayColumnsContainAllGroupByColumns()) {
      return root;
    }
  }
 else   if (containsAggregateExpression) {
    return root;
  }
  return handleDistinct(root);
}
