{
  assert(m_needed);
  String mvTableName=m_mvTable.getTypeName();
  Set<SchemaColumn> mvDDLGroupbyColumns=new HashSet<SchemaColumn>();
  NodeSchema inlineProjSchema=new NodeSchema();
  for (  SchemaColumn scol : scanColumns) {
    inlineProjSchema.addColumn(scol);
  }
  for (int i=0; i < m_numOfGroupByColumns; i++) {
    Column mvCol=mvColumnArray.get(i);
    String colName=mvCol.getName();
    TupleValueExpression tve=new TupleValueExpression();
    tve.setColumnIndex(i);
    tve.setColumnName(colName);
    tve.setTableName(mvTableName);
    tve.setColumnAlias(colName);
    tve.setValueType(VoltType.get((byte)mvCol.getType()));
    tve.setValueSize(mvCol.getSize());
    SchemaColumn scol=new SchemaColumn(mvTableName,colName,colName,tve);
    mvDDLGroupbyColumns.add(scol);
    if (!scanColumns.contains(scol)) {
      scanColumns.add(scol);
      inlineProjSchema.addColumn(scol);
    }
  }
  m_scanInlinedProjectionNode=new ProjectionPlanNode();
  m_scanInlinedProjectionNode.setOutputSchema(inlineProjSchema);
  Map<String,ExpressionType> mvColumnAggType=new HashMap<String,ExpressionType>();
  for (int i=m_numOfGroupByColumns; i < mvColumnArray.size(); i++) {
    Column mvCol=mvColumnArray.get(i);
    ExpressionType reAggType=ExpressionType.get(mvCol.getAggregatetype());
    if (reAggType == ExpressionType.AGGREGATE_COUNT_STAR || reAggType == ExpressionType.AGGREGATE_COUNT) {
      reAggType=ExpressionType.AGGREGATE_SUM;
    }
    mvColumnAggType.put(mvCol.getName(),reAggType);
  }
  m_reAggNode=new HashAggregatePlanNode();
  int outputColumnIndex=0;
  NodeSchema aggSchema=new NodeSchema();
  for (  SchemaColumn scol : scanColumns) {
    if (mvDDLGroupbyColumns.contains(scol)) {
      m_reAggNode.addGroupByExpression(scol.getExpression());
    }
 else {
      ExpressionType reAggType=mvColumnAggType.get(scol.getColumnName());
      assert(reAggType != null);
      AbstractExpression agg_input_expr=scol.getExpression();
      assert(agg_input_expr instanceof TupleValueExpression);
      m_reAggNode.addAggregate(reAggType,false,outputColumnIndex,agg_input_expr);
    }
    aggSchema.addColumn(scol);
    outputColumnIndex++;
  }
  m_reAggNode.setOutputSchema(aggSchema);
}
