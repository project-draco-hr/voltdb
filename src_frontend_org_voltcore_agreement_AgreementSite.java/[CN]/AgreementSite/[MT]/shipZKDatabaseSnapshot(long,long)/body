{
  m_recoveryLog.info("Shipping ZK snapshot from " + m_hsId + " to "+ faultedInitiator);
  ByteArrayOutputStream baos=new ByteArrayOutputStream();
  DataOutputStream dos=new DataOutputStream(baos);
  BinaryOutputArchive boa=new BinaryOutputArchive(dos);
  m_server.getZKDatabase().serializeSnapshot(boa);
  dos.flush();
  byte databaseBytes[]=org.xerial.snappy.Snappy.compress(baos.toByteArray());
  ByteBuffer metadata=ByteBuffer.allocate(9);
  metadata.put(BINARY_PAYLOAD_SNAPSHOT);
  metadata.putLong(txnId);
  BinaryPayloadMessage bpm=new BinaryPayloadMessage(metadata.array(),databaseBytes);
  try {
    m_mailbox.send(faultedInitiator,bpm);
  }
 catch (  MessagingException e) {
    throw new IOException(e);
  }
  m_siteRequestingRecovery=null;
  m_recoverBeforeTxn=null;
}
