{
  Buffer buf=buffer.buffer();
  int len=0;
  if (buf instanceof NIOBuffer) {
    final NIOBuffer nbuf=(NIOBuffer)buf;
    final ByteBuffer bbuf=nbuf.getByteBuffer();
synchronized (bbuf) {
      try {
        bbuf.position(buffer.getIndex());
        bbuf.limit(buffer.putIndex());
        len=_channel.write(bbuf);
      }
  finally {
        if (len > 0)         buffer.skip(len);
        bbuf.position(0);
        bbuf.limit(bbuf.capacity());
      }
    }
  }
 else   if (buf instanceof RandomAccessFileBuffer) {
    len=buffer.length();
    ((RandomAccessFileBuffer)buf).writeTo(_channel,buffer.getIndex(),buffer.length());
    if (len > 0)     buffer.skip(len);
  }
 else   if (buffer.array() != null) {
    ByteBuffer b=ByteBuffer.wrap(buffer.array(),buffer.getIndex(),buffer.length());
    len=_channel.write(b);
    if (len > 0)     buffer.skip(len);
  }
 else {
    throw new IOException("Not Implemented");
  }
  return len;
}
