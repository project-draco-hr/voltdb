import os, sys, shutil, datetime
from fabric.api import run, cd, local, get, settings, lcd, put
from fabric_ssh_config import getSSHInfoForHost
username = 'test'
builddir = (('/tmp/' + username) + '/buildtemp')
version = 'UNKNOWN'
if ((len(sys.argv) > 3) or ((len(sys.argv) == 2) and (sys.argv[1] == '-h'))):
    print 'usage:'
    print '   build-kit.py'
    print '   build-kit.py git-tag'
    print '   build-kit.py voltdb-git-SHA pro-git-SHA'
proTreeish = 'master'
voltdbTreeish = 'master'
createCandidate = True
if (len(sys.argv) == 2):
    createCandidate = False
    proTreeish = sys.argv[1]
    voltdbTreeish = sys.argv[1]
if (len(sys.argv) == 3):
    createCandidate = False
    voltdbTreeish = sys.argv[1]
    proTreeish = sys.argv[2]
print ('Building with pro: %s and voltdb: %s' % (proTreeish, voltdbTreeish))
print ('Create link for releases/candidate = %s' % createCandidate)
version = 'unknown'
releaseDir = 'unknown'
volt5f = getSSHInfoForHost('volt5f')
voltmini = getSSHInfoForHost('voltmini')
volt12c = getSSHInfoForHost('volt12c')
with settings(user=username, host_string=volt5f[1], disable_known_hosts=True, key_filename=volt5f[0]):
    version = checkoutCode(voltdbTreeish, proTreeish)
    if (voltdbTreeish == 'master'):
        releaseDir = ((os.getenv('HOME') + '/releases/') + version)
    else:
        releaseDir = ('%s/releases/one-offs/%s-%s-%s' % (os.getenv('HOME'), version, voltdbTreeish, proTreeish))
    makeReleaseDir(releaseDir)
    print ('VERSION: ' + version)
    buildCommunity()
    copyCommunityFilesToReleaseDir(releaseDir, version, 'LINUX')
    buildPro()
    copyEnterpriseFilesToReleaseDir(releaseDir, version, 'LINUX')
with settings(user=username, host_string=voltmini[1], disable_known_hosts=True, key_filename=voltmini[0]):
    version2 = checkoutCode(voltdbTreeish, proTreeish)
    assert (version == version2)
    buildCommunity()
    copyCommunityFilesToReleaseDir(releaseDir, version, 'MAC')
    buildPro()
    copyEnterpriseFilesToReleaseDir(releaseDir, version, 'MAC')
with settings(user=username, host_string=volt12c[1], disable_known_hosts=True, key_filename=volt12c[0]):
    debbuilddir = ('%s/deb_build/' % builddir)
    run(('rm -rf ' + debbuilddir))
    run(('mkdir -p ' + debbuilddir))
    with cd(debbuilddir):
        put('tools/voltdb-install.py', '.')
        commbld = ('%s-voltdb-%s.tar.gz' % ('LINUX', version))
        put(('%s/%s' % (releaseDir, commbld)), '.')
        run(('sudo python voltdb-install.py -D ' + commbld))
        get(('voltdb_%s-1_amd64.deb' % version), releaseDir)
        entbld = ('%s-voltdb-ent-%s.tar.gz' % ('LINUX', version))
        put(('%s/%s' % (releaseDir, entbld)), '.')
        run(('sudo python voltdb-install.py -D ' + entbld))
        get(('voltdb-ent_%s-1_amd64.deb' % version), releaseDir)
computeChecksums(releaseDir)
if createCandidate:
    createCandidateSysmlink(releaseDir)
archiveDir = ((os.getenv('HOME') + '/releases/archive/') + version)
backupReleaseDir(releaseDir, archiveDir, version)
