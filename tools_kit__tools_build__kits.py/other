import os, sys, shutil, datetime
from fabric.api import run, cd, local, get, settings, lcd
from fabric_ssh_config import getSSHInfoForHost
builddir = (('/tmp/' + os.getenv('USER')) + '/buildtemp')
version = 'UNKNOWN'
if (len(sys.argv) > 3):
    print 'usage'
argv = sys.argv
if (len(argv) == 1):
    argv = ['build-kit.py', 'trunk', 'branches/rest']
if (len(argv) == 2):
    argv = ['build-kit.py', argv[0], argv[0]]
eng_svn_url = getSVNURL('https://svn.voltdb.com/eng/', argv[1])
pro_svn_url = getSVNURL('https://svn.voltdb.com/pro/', argv[2])
version = 'unknown'
releaseDir = 'unknown'
volt5f = getSSHInfoForHost('volt5f')
voltmini = getSSHInfoForHost('voltmini')
with settings(user='test', host_string=volt5f[1], disable_known_hosts=True, key_filename=volt5f[0]):
    version = checkoutCode(eng_svn_url, pro_svn_url)
    releaseDir = ((os.getenv('HOME') + '/releases/') + version)
    makeReleaseDir(releaseDir)
    print ('VERSION: ' + version)
    buildCommunity()
    copyCommunityFilesToReleaseDir(releaseDir, version, 'LINUX')
    buildPro()
    copyEnterpriseFilesToReleaseDir(releaseDir, version, 'LINUX')
with settings(user='test', host_string=voltmini[1], disable_known_hosts=True, key_filename=voltmini[0]):
    version2 = checkoutCode(eng_svn_url, pro_svn_url)
    assert (version == version2)
    buildCommunity()
    copyCommunityFilesToReleaseDir(releaseDir, version, 'MAC')
    buildPro()
    copyEnterpriseFilesToReleaseDir(releaseDir, version, 'MAC')
computeChecksums(releaseDir)
createCandidateSysmlink(releaseDir)
backupReleaseDir(releaseDir)
