{
  if (m_writeFailed) {
    tupleData.discard();
    return null;
  }
  m_outstandingWriteTasks.incrementAndGet();
  Future<?> writeTask=m_es.submit(new Callable<Object>(){
    @Override public Object call() throws Exception {
      boolean tupleDataDiscarded=false;
      try {
        if (m_acceptOneWrite) {
          m_acceptOneWrite=false;
        }
 else {
          if (m_simulateBlockedWrite != null) {
            m_simulateBlockedWrite.await();
          }
          if (m_simulateFullDiskWritingChunk) {
            throw new IOException("Disk full");
          }
        }
        ByteBuffer bufferToWrite=tupleData.b;
        if (prependLength) {
          m_compressionBuffer.clear();
          m_compressionBuffer.position(16);
          tupleData.b.position(16);
          final int compressedSize=CompressionService.compressBuffer(tupleData.b,m_compressionBuffer);
          m_compressionBuffer.limit(16 + compressedSize);
          m_compressionBuffer.position(4);
          tupleData.b.position(4);
          tupleData.b.limit(16);
          m_compressionBuffer.put(tupleData.b);
          m_compressionBuffer.position(0);
          m_compressionBuffer.putInt(m_compressionBuffer.remaining() - 16);
          m_compressionBuffer.position(0);
          tupleDataDiscarded=true;
          tupleData.discard();
          bufferToWrite=m_compressionBuffer;
        }
        m_bytesAllowedBeforeSync.acquire(bufferToWrite.remaining());
        int totalWritten=0;
        while (bufferToWrite.hasRemaining()) {
          totalWritten+=m_channel.write(bufferToWrite);
        }
        m_bytesWritten+=totalWritten;
        m_bytesWrittenSinceLastSync.addAndGet(totalWritten);
      }
 catch (      IOException e) {
        m_writeException=e;
        hostLog.error("Error while attempting to write snapshot data to file " + m_file,e);
        m_writeFailed=true;
        throw e;
      }
 finally {
        if (!tupleDataDiscarded) {
          tupleData.discard();
        }
synchronized (m_outstandingWriteTasks) {
          if (m_outstandingWriteTasks.decrementAndGet() == 0) {
            m_outstandingWriteTasks.notify();
          }
        }
      }
      return null;
    }
  }
);
  return writeTask;
}
