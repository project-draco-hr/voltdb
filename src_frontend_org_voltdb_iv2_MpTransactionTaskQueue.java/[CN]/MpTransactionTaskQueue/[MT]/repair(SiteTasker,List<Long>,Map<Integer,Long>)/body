{
  m_taskQueue.offer(task);
  Map<Long,TransactionTask> currentSet;
  if (!m_currentReads.isEmpty()) {
    assert(m_currentWrites.isEmpty());
    tmLog.debug("MpTTQ: repairing reads");
    currentSet=m_currentReads;
  }
 else {
    tmLog.debug("MpTTQ: repairing writes");
    currentSet=m_currentWrites;
  }
  for (  Entry<Long,TransactionTask> e : currentSet.entrySet()) {
    if (e.getValue() instanceof MpProcedureTask) {
      MpProcedureTask next=(MpProcedureTask)e.getValue();
      tmLog.debug("MpTTQ: poisoning task: " + next);
      next.doRestart(masters,partitionMasters);
      MpTransactionState txn=(MpTransactionState)next.getTransactionState();
      FragmentTaskMessage dummy=new FragmentTaskMessage(0L,0L,0L,0L,false,false,false);
      FragmentResponseMessage poison=new FragmentResponseMessage(dummy,0L);
      TransactionRestartException restart=new TransactionRestartException("Transaction being restarted due to fault recovery or shutdown.",next.getTxnId());
      poison.setStatus(FragmentResponseMessage.UNEXPECTED_ERROR,restart);
      txn.offerReceivedFragmentResponse(poison);
    }
 else {
      assert(false);
    }
  }
  Iterator<TransactionTask> iter=m_backlog.iterator();
  while (iter.hasNext()) {
    TransactionTask tt=iter.next();
    if (task instanceof MpProcedureTask) {
      MpProcedureTask next=(MpProcedureTask)tt;
      next.updateMasters(masters,partitionMasters);
    }
 else {
      assert(false);
    }
  }
  iter=m_readBacklog.iterator();
  while (iter.hasNext()) {
    TransactionTask tt=iter.next();
    if (task instanceof MpProcedureTask) {
      MpProcedureTask next=(MpProcedureTask)tt;
      next.updateMasters(masters,partitionMasters);
    }
 else {
      assert(false);
    }
  }
}
