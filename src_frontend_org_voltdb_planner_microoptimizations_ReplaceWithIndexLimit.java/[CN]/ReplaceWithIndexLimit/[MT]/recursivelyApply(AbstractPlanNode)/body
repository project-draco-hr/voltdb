{
  assert(plan != null);
  ArrayList<AbstractPlanNode> children=new ArrayList<AbstractPlanNode>();
  for (int i=0; i < plan.getChildCount(); i++)   children.add(plan.getChild(i));
  for (  AbstractPlanNode child : children) {
    AbstractPlanNode newChild=recursivelyApply(child);
    if (newChild == child) {
      continue;
    }
    child.removeFromGraph();
    plan.addAndLinkChild(newChild);
  }
  if ((plan instanceof AggregatePlanNode) == false)   return plan;
  assert(plan.getChildCount() == 1);
  AggregatePlanNode aggplan=(AggregatePlanNode)plan;
  SortDirectionType sortDirection=SortDirectionType.INVALID;
  if (aggplan.isTableMin()) {
    sortDirection=SortDirectionType.ASC;
  }
 else   if (aggplan.isTableMax()) {
    sortDirection=SortDirectionType.DESC;
  }
 else {
    return plan;
  }
  AbstractPlanNode child=plan.getChild(0);
  AbstractExpression aggExpr=aggplan.getFirstAggregateExpression();
  if (child instanceof SeqScanPlanNode) {
    if (((SeqScanPlanNode)child).getPredicate() != null) {
      return plan;
    }
    CatalogMap<Index> allIndexes=db.getTables().get(((SeqScanPlanNode)child).getTargetTableName()).getIndexes();
    IndexScanPlanNode emptyNode=new IndexScanPlanNode();
    Index ret=findQualifiedIndex(emptyNode,allIndexes,aggExpr);
    if (ret == null) {
      return plan;
    }
 else {
      IndexScanPlanNode ispn=new IndexScanPlanNode((SeqScanPlanNode)child,aggplan,ret,sortDirection);
      ispn.setBindings(emptyNode.getBindings());
      LimitPlanNode lpn=new LimitPlanNode();
      lpn.setLimit(1);
      lpn.setOffset(0);
      ispn.addInlinePlanNode(lpn);
      ispn.generateOutputSchema(db);
      plan.clearChildren();
      plan.addAndLinkChild(ispn);
      return plan;
    }
  }
  if ((child instanceof IndexScanPlanNode) == false) {
    return plan;
  }
  if (((IndexScanPlanNode)child).getPredicate() != null) {
    return plan;
  }
  IndexScanPlanNode ispn=(IndexScanPlanNode)child;
  if (ispn.getLookupType() != IndexLookupType.EQ && Math.abs(ispn.getSearchKeyExpressions().size() - ExpressionUtil.uncombine(ispn.getEndExpression()).size()) > 1) {
    return plan;
  }
  if (sortDirection == SortDirectionType.DESC && ispn.getSortDirection() == SortDirectionType.INVALID) {
    List<AbstractExpression> endExprs=ExpressionUtil.uncombine(ispn.getEndExpression());
    if (endExprs.size() > 1 || (!endExprs.isEmpty() && aggExpr.bindingToIndexedExpression(endExprs.get(0).getLeft()) == null)) {
      return plan;
    }
  }
  List<AbstractExpression> exprs=null;
  if (ExpressionUtil.uncombine(ispn.getEndExpression()).size() > ispn.getSearchKeyExpressions().size()) {
    if (sortDirection == SortDirectionType.DESC) {
      return plan;
    }
    List<AbstractExpression> endExprs=ExpressionUtil.uncombine(ispn.getEndExpression());
    AbstractExpression lastEndExpr=endExprs.get(ispn.getSearchKeyExpressions().size());
    if ((lastEndExpr.getExpressionType() == ExpressionType.COMPARE_LESSTHAN || lastEndExpr.getExpressionType() == ExpressionType.COMPARE_LESSTHANOREQUALTO) && lastEndExpr.getLeft().equals(aggExpr)) {
      exprs=new ArrayList<AbstractExpression>(endExprs);
      exprs.remove(lastEndExpr);
    }
  }
  if (ispn.getSearchKeyExpressions().size() > ExpressionUtil.uncombine(ispn.getEndExpression()).size()) {
    if (ispn.getLookupType() != IndexLookupType.GT && ispn.getLookupType() != IndexLookupType.GTE) {
      return plan;
    }
  }
  exprs=(exprs == null) ? ExpressionUtil.uncombine(ispn.getEndExpression()) : exprs;
  if (!checkIndex(ispn,ispn.getCatalogIndex(),aggExpr,exprs,ispn.getBindings())) {
    return plan;
  }
 else {
    ispn.setSortDirection(sortDirection);
    LimitPlanNode lpn=new LimitPlanNode();
    lpn.setLimit(1);
    lpn.setOffset(0);
    ispn.addInlinePlanNode(lpn);
    if (sortDirection == SortDirectionType.DESC && !ispn.getSearchKeyExpressions().isEmpty() && exprs.isEmpty()) {
      AbstractExpression newPredicate=new ComparisonExpression();
      if (ispn.getLookupType() == IndexLookupType.GT)       newPredicate.setExpressionType(ExpressionType.COMPARE_GREATERTHAN);
      if (ispn.getLookupType() == IndexLookupType.GTE)       newPredicate.setExpressionType(ExpressionType.COMPARE_GREATERTHANOREQUALTO);
      newPredicate.setRight(ispn.getSearchKeyExpressions().get(0));
      newPredicate.setLeft(aggExpr);
      newPredicate.setValueType(aggExpr.getValueType());
      ispn.clearSearchKeyExpression();
      aggplan.setPredicate(newPredicate);
    }
    plan.generateOutputSchema(db);
    return plan;
  }
}
