{
  long current=0;
  voltQueueSQL(estimatesSelect,EXPECT_ZERO_OR_ONE_ROW,appId);
  voltQueueSQL(exactUpsert,EXPECT_ZERO_OR_ONE_ROW,appId,hashedDeviceId);
  voltQueueSQL(exactCardinality,EXPECT_ONE_ROW,appId);
  VoltTable[] results=voltExecuteSQL();
  VoltTable estimatesTable=results[0];
  if (estimatesTable.advanceRow()) {
    estimatesTable.advanceRow();
    current=estimatesTable.getLong("devicecount");
  }
  long newCardinality=results[2].asScalarLong();
  if (newCardinality != current) {
    voltQueueSQL(estimatesUpsert,EXPECT_SCALAR_MATCH(1),appId,newCardinality);
    voltExecuteSQL(true);
  }
  return newCardinality;
}
