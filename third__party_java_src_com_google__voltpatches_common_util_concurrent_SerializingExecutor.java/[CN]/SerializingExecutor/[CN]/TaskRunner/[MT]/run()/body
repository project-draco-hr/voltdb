{
  boolean stillRunning=true;
  try {
    while (true) {
      Preconditions.checkState(isThreadScheduled);
      Runnable nextToRun;
synchronized (internalLock) {
        nextToRun=waitQueue.poll();
        if (nextToRun == null) {
          isThreadScheduled=false;
          stillRunning=false;
          break;
        }
      }
      try {
        nextToRun.run();
      }
 catch (      RuntimeException e) {
        log.log(Level.SEVERE,"Exception while executing runnable " + nextToRun,e);
      }
    }
  }
  finally {
    if (stillRunning) {
synchronized (internalLock) {
        isThreadScheduled=false;
      }
    }
  }
}
