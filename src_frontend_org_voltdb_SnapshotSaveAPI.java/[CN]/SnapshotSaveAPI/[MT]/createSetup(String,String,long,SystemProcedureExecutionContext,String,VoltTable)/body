{
{
    final int numLocalSites=VoltDB.instance().getLocalSites().values().size();
    final ArrayList<SnapshotDataTarget> targets=new ArrayList<SnapshotDataTarget>();
    try {
      final ArrayDeque<SnapshotTableTask> partitionedSnapshotTasks=new ArrayDeque<SnapshotTableTask>();
      final ArrayList<SnapshotTableTask> replicatedSnapshotTasks=new ArrayList<SnapshotTableTask>();
      assert(SnapshotSiteProcessor.ExecutionSitesCurrentlySnapshotting.get() == -1);
      final List<Table> tables=SnapshotUtil.getTablesToSave(context.getDatabase());
      SnapshotUtil.recordSnapshotTableList(txnId,file_path,file_nonce,tables,context.getExecutionSite().getCorrespondingHostId(),SnapshotSiteProcessor.getExportSequenceNumbers());
      final AtomicInteger numTables=new AtomicInteger(tables.size());
      final SnapshotRegistry.Snapshot snapshotRecord=SnapshotRegistry.startSnapshot(txnId,context.getExecutionSite().getCorrespondingHostId(),file_path,file_nonce,tables.toArray(new Table[0]));
      for (      final Table table : SnapshotUtil.getTablesToSave(context.getDatabase())) {
        String canSnapshot="SUCCESS";
        String err_msg="";
        final File saveFilePath=SnapshotUtil.constructFileForTable(table,file_path,file_nonce,context.getSite().getHost().getTypeName());
        SnapshotDataTarget sdt=null;
        try {
          sdt=constructSnapshotDataTargetForTable(context,saveFilePath,table,context.getSite().getHost(),context.getCluster().getPartitions().size(),txnId);
          targets.add(sdt);
          final SnapshotDataTarget sdtFinal=sdt;
          final Runnable onClose=new Runnable(){
            @Override public void run(){
              snapshotRecord.updateTable(table.getTypeName(),new SnapshotRegistry.Snapshot.TableUpdater(){
                @Override public SnapshotRegistry.Snapshot.Table update(                SnapshotRegistry.Snapshot.Table registryTable){
                  return snapshotRecord.new Table(registryTable,sdtFinal.getBytesWritten(),sdtFinal.getLastWriteException());
                }
              }
);
              int tablesLeft=numTables.decrementAndGet();
              if (tablesLeft == 0) {
                final SnapshotRegistry.Snapshot completed=SnapshotRegistry.finishSnapshot(snapshotRecord);
                final double duration=(completed.timeFinished - org.voltdb.TransactionIdManager.getTimestampFromTransactionId(completed.txnId)) / 1000.0;
                HOST_LOG.info("Snapshot " + snapshotRecord.nonce + " finished at "+ completed.timeFinished+ " and took "+ duration+ " seconds ");
              }
            }
          }
;
          sdt.setOnCloseHandler(onClose);
          final SnapshotTableTask task=new SnapshotTableTask(table.getRelativeIndex(),sdt,table.getIsreplicated(),table.getTypeName());
          if (table.getIsreplicated()) {
            replicatedSnapshotTasks.add(task);
          }
 else {
            partitionedSnapshotTasks.offer(task);
          }
        }
 catch (        IOException ex) {
          try {
            if (sdt != null) {
              targets.remove(sdt);
              sdt.close();
            }
          }
 catch (          Exception e) {
            HOST_LOG.error(e);
          }
          StringWriter sw=new StringWriter();
          PrintWriter pw=new PrintWriter(sw);
          ex.printStackTrace(pw);
          pw.flush();
          canSnapshot="FAILURE";
          err_msg="SNAPSHOT INITIATION OF " + saveFilePath + "RESULTED IN IOException: \n"+ sw.toString();
        }
        result.addRow(Integer.parseInt(context.getSite().getHost().getTypeName()),hostname,table.getTypeName(),canSnapshot,err_msg);
      }
synchronized (SnapshotSiteProcessor.m_taskListsForSites) {
        boolean aborted=false;
        if (!partitionedSnapshotTasks.isEmpty() || !replicatedSnapshotTasks.isEmpty()) {
          SnapshotSiteProcessor.ExecutionSitesCurrentlySnapshotting.set(VoltDB.instance().getLocalSites().values().size());
          for (int ii=0; ii < numLocalSites; ii++) {
            SnapshotSiteProcessor.m_taskListsForSites.add(new ArrayDeque<SnapshotTableTask>());
          }
        }
 else {
          SnapshotRegistry.discardSnapshot(snapshotRecord);
          aborted=true;
        }
        for (int ii=0; ii < numLocalSites && !partitionedSnapshotTasks.isEmpty(); ii++) {
          SnapshotSiteProcessor.m_taskListsForSites.get(ii).addAll(partitionedSnapshotTasks);
        }
        int siteIndex=0;
        for (        SnapshotTableTask t : replicatedSnapshotTasks) {
          SnapshotSiteProcessor.m_taskListsForSites.get(siteIndex++ % numLocalSites).offer(t);
        }
        if (!aborted) {
          logSnapshotStartToZK(txnId,context,file_nonce);
        }
      }
    }
 catch (    Exception ex) {
      SnapshotSiteProcessor.m_taskListsForSites.clear();
      for (      SnapshotDataTarget sdt : targets) {
        try {
          sdt.close();
        }
 catch (        Exception e) {
          HOST_LOG.error(ex);
        }
      }
      StringWriter sw=new StringWriter();
      PrintWriter pw=new PrintWriter(sw);
      ex.printStackTrace(pw);
      pw.flush();
      result.addRow(Integer.parseInt(context.getSite().getHost().getTypeName()),hostname,"","FAILURE","SNAPSHOT INITIATION OF " + file_path + file_nonce+ "RESULTED IN Exception: \n"+ sw.toString());
      HOST_LOG.error(ex);
    }
 finally {
      SnapshotSiteProcessor.m_snapshotPermits.release(numLocalSites);
    }
  }
}
