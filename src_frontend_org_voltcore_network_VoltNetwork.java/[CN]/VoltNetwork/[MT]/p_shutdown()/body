{
  try {
    try {
synchronized (m_networkThreads) {
        for (        LinkedBlockingQueue<Runnable> q : m_taskQueues) {
          q.offer(new Runnable(){
            @Override public void run(){
              throw new TerminateThreadException();
            }
          }
);
        }
        for (        final WeakReference<Thread> r : m_networkThreads) {
          final Thread t=r.get();
          if (t != null) {
            t.join();
          }
        }
      }
    }
 catch (    InterruptedException e) {
      m_logger.error(e);
    }
    Set<SelectionKey> keys=m_selector.keys();
    for (    SelectionKey key : keys) {
      VoltPort port=(VoltPort)key.attachment();
      if (port != null) {
        try {
          unregisterChannel(port);
        }
 catch (        Exception e) {
          networkLog.error("Exception unregisering port " + port,e);
        }
      }
    }
synchronized (m_poolsToClearOnShutdown) {
      for (      NetworkDBBPool p : m_poolsToClearOnShutdown) {
        p.clear();
      }
      m_poolsToClearOnShutdown.clear();
    }
    try {
      m_selector.close();
    }
 catch (    IOException e) {
      m_logger.error(null,e);
    }
  }
  finally {
    this.notifyAll();
  }
}
