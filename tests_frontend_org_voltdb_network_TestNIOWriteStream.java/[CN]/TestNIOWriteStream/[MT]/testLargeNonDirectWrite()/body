{
  MockChannel channel=new MockChannel(MockChannel.SINK);
  MockPort port=new MockPort();
  NIOWriteStream wstream=new NIOWriteStream(port);
  ByteBuffer tmp=ByteBuffer.allocate(NIOWriteStream.MAX_GATHERING_WRITE * 3);
  final AtomicInteger discardCount=new AtomicInteger(0);
  BBContainer bbc=new BBContainer(tmp,0L){
    @Override public void discard(){
      discardCount.addAndGet(1);
    }
  }
;
  assertTrue(wstream.enqueue(bbc));
  assertTrue(port.checkWriteSet());
  int written=wstream.drainTo(channel,wstream.swapAndSerializeQueuedWrites(pool));
  assertEquals(NIOWriteStream.MAX_GATHERING_WRITE * 3,written);
  assertFalse(channel.didOversizeWrite);
  assertTrue(discardCount.get() == 1);
  wstream.shutdown();
}
