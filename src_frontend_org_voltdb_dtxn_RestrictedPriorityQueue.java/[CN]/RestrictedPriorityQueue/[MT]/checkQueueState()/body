{
  QueueState newState=QueueState.UNBLOCKED;
  TransactionState ts=super.peek();
  LastInitiatorData lid=null;
  if (ts == null) {
    newState=QueueState.BLOCKED_EMPTY;
  }
 else {
    if (ts.txnId > m_newestCandidateTransaction) {
      newState=QueueState.BLOCKED_ORDERING;
    }
 else {
      lid=m_initiatorData.get(ts.initiatorSiteId);
      if (ts.txnId > lid.m_lastSafeTxnId) {
        newState=QueueState.BLOCKED_SAFETY;
      }
    }
  }
  if (newState != m_state) {
    if ((newState == QueueState.BLOCKED_ORDERING) || (newState == QueueState.BLOCKED_SAFETY)) {
      m_blockTime=System.currentTimeMillis();
    }
    if (newState == QueueState.UNBLOCKED) {
      if ((m_state == QueueState.BLOCKED_ORDERING) || (m_state == QueueState.BLOCKED_SAFETY)) {
        long blockedFor=System.currentTimeMillis() - m_blockTime;
      }
    }
    if ((m_state == QueueState.BLOCKED_ORDERING) || (m_state == QueueState.BLOCKED_SAFETY)) {
      assert(m_state != QueueState.BLOCKED_EMPTY);
    }
    if (newState == QueueState.BLOCKED_SAFETY) {
      assert(ts != null);
      assert(lid != null);
      sendHearbeatResponse(ts,lid);
    }
    m_state=newState;
  }
  return m_state;
}
