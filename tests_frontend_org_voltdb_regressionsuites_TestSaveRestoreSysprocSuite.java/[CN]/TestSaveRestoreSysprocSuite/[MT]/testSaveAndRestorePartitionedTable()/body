{
  if (isValgrind())   return;
  System.out.println("Starting testSaveAndRestorePartitionedTable");
  int num_partitioned_items_per_chunk=120;
  int num_partitioned_chunks=10;
  Client client=getClient();
  loadLargePartitionedTable(client,"PARTITION_TESTER",num_partitioned_items_per_chunk,num_partitioned_chunks);
  VoltTable[] results=null;
  Thread.sleep(1000);
  VoltTable orig_mem=null;
  try {
    orig_mem=client.callProcedure("@Statistics","memory",0).getResults()[0];
    System.out.println("STATS: " + orig_mem.toString());
  }
 catch (  Exception ex) {
    ex.printStackTrace();
    fail("Statistics exception: " + ex.getMessage());
  }
  DefaultSnapshotDataTarget.m_simulateFullDiskWritingHeader=true;
  results=saveTablesWithDefaultOptions(client);
  deleteTestFiles();
  while (results[0].advanceRow()) {
    assertTrue(results[0].getString("RESULT").equals("FAILURE"));
  }
  DefaultSnapshotDataTarget.m_simulateFullDiskWritingHeader=false;
  validateSnapshot(false);
  results=saveTablesWithDefaultOptions(client);
  validateSnapshot(true);
  while (results[0].advanceRow()) {
    if (!results[0].getString("RESULT").equals("SUCCESS")) {
      System.out.println(results[0].getString("ERR_MSG"));
    }
    assertTrue(results[0].getString("RESULT").equals("SUCCESS"));
  }
  try {
    checkSnapshotStatus(client,TMPDIR,TESTNONCE,null,"SUCCESS",8);
  }
 catch (  Exception ex) {
    ex.printStackTrace();
    fail("SnapshotRestore exception: " + ex.getMessage());
  }
  m_config.shutDown();
  m_config.startUp();
  client=getClient();
  try {
    results=client.callProcedure("@SnapshotRestore",TMPDIR,TESTNONCE).getResults();
    while (results[0].advanceRow()) {
      if (results[0].getString("RESULT").equals("FAILURE")) {
        fail(results[0].getString("ERR_MSG"));
      }
    }
  }
 catch (  Exception ex) {
    ex.printStackTrace();
    fail("SnapshotRestore exception: " + ex.getMessage());
  }
  boolean threwException=false;
  try {
    results=client.callProcedure("@SnapshotRestore",TMPDIR,TESTNONCE).getResults();
    while (results[0].advanceRow()) {
      if (results[0].getString("RESULT").equals("FAILURE")) {
        fail(results[0].getString("ERR_MSG"));
      }
    }
  }
 catch (  Exception ex) {
    threwException=true;
  }
  assertTrue(threwException);
  VoltDB.instance().getHostMessenger().getZK().delete(VoltZK.restoreMarker,-1);
  VoltDB.instance().getHostMessenger().getZK().delete(VoltZK.perPartitionTxnIds,-1);
  threwException=false;
  try {
    JSONObject jsObj=new JSONObject();
    jsObj.put(SnapshotRestore.JSON_NONCE,TESTNONCE);
    jsObj.put(SnapshotRestore.JSON_PATH,TMPDIR);
    jsObj.put(SnapshotRestore.JSON_DUPLICATES_PATH,TMPDIR);
    results=client.callProcedure("@SnapshotRestore",jsObj.toString()).getResults();
    while (results[0].advanceRow()) {
      if (results[0].getString("RESULT").equals("FAILURE")) {
        fail(results[0].getString("ERR_MSG"));
      }
    }
  }
 catch (  Exception ex) {
    threwException=true;
  }
  assertFalse(threwException);
  boolean haveCSVFile=false;
  for (  File f : new File(TMPDIR).listFiles()) {
    final String name=f.getName();
    if (name.startsWith("PARTITION_TESTER") && name.endsWith(".csv")) {
      haveCSVFile=true;
      if (!(f.length() > 30000)) {
        fail("Duplicates file is not as large as expected");
      }
    }
  }
  assertTrue(haveCSVFile);
  checkTable(client,"PARTITION_TESTER","PT_ID",num_partitioned_items_per_chunk * num_partitioned_chunks);
  boolean ok=false;
  int foundItem=0;
  while (!ok) {
    ok=true;
    foundItem=0;
    results=client.callProcedure("@Statistics","table",0).getResults();
    while (results[0].advanceRow()) {
      if (results[0].getString("TABLE_NAME").equals("PARTITION_TESTER")) {
        long tupleCount=results[0].getLong("TUPLE_COUNT");
        ok=(ok & (tupleCount == ((num_partitioned_items_per_chunk * num_partitioned_chunks) / 3)));
        ++foundItem;
      }
    }
    ok=ok & (foundItem == 3);
  }
  results=client.callProcedure("@Statistics","table",0).getResults();
  while (results[0].advanceRow()) {
    if (results[0].getString("TABLE_NAME").equals("PARTITION_TESTER")) {
      assertEquals((num_partitioned_items_per_chunk * num_partitioned_chunks) / 3,results[0].getLong("TUPLE_COUNT"));
    }
  }
  m_config.shutDown();
  m_config.startUp();
  deleteTestFiles();
  DefaultSnapshotDataTarget.m_simulateFullDiskWritingChunk=true;
  org.voltdb.sysprocs.SnapshotRegistry.clear();
  client=getClient();
  loadLargePartitionedTable(client,"PARTITION_TESTER",num_partitioned_items_per_chunk,num_partitioned_chunks);
  results=saveTablesWithDefaultOptions(client);
  validateSnapshot(false);
  try {
    results=client.callProcedure("@SnapshotStatus").getResults();
    boolean hasFailure=false;
    while (results[0].advanceRow())     hasFailure|=results[0].getString("RESULT").equals("FAILURE");
    assertTrue(hasFailure);
  }
 catch (  Exception ex) {
    ex.printStackTrace();
    fail("SnapshotRestore exception: " + ex.getMessage());
  }
  DefaultSnapshotDataTarget.m_simulateFullDiskWritingChunk=false;
  deleteTestFiles();
  results=saveTablesWithDefaultOptions(client);
  validateSnapshot(true);
  m_config.shutDown();
  m_config.startUp();
  client=getClient();
  try {
    results=client.callProcedure("@SnapshotRestore",TMPDIR,TESTNONCE).getResults();
  }
 catch (  Exception ex) {
    ex.printStackTrace();
    fail("SnapshotRestore exception: " + ex.getMessage());
  }
  Thread.sleep(1000);
  VoltTable final_mem=null;
  try {
    final_mem=client.callProcedure("@Statistics","memory",0).getResults()[0];
    System.out.println("STATS: " + final_mem.toString());
  }
 catch (  Exception ex) {
    ex.printStackTrace();
    fail("Statistics exception: " + ex.getMessage());
  }
  checkTable(client,"PARTITION_TESTER","PT_ID",num_partitioned_items_per_chunk * num_partitioned_chunks);
  results=client.callProcedure("@Statistics","table",0).getResults();
  ok=false;
  foundItem=0;
  while (!ok) {
    ok=true;
    foundItem=0;
    results=client.callProcedure("@Statistics","table",0).getResults();
    while (results[0].advanceRow()) {
      if (results[0].getString("TABLE_NAME").equals("PARTITION_TESTER")) {
        long tupleCount=results[0].getLong("TUPLE_COUNT");
        ok=(ok & (tupleCount == ((num_partitioned_items_per_chunk * num_partitioned_chunks) / 3)));
        ++foundItem;
      }
    }
    ok=ok & (foundItem == 3);
  }
  assertEquals(3,foundItem);
  results=client.callProcedure("@Statistics","table",0).getResults();
  while (results[0].advanceRow()) {
    if (results[0].getString("TABLE_NAME").equals("PARTITION_TESTER")) {
      assertEquals((num_partitioned_items_per_chunk * num_partitioned_chunks) / 3,results[0].getLong("TUPLE_COUNT"));
    }
  }
}
