{
  if (isValgrind())   return;
  System.out.println("Starting testCorruptedFiles");
  int num_replicated_items=1000;
  int num_partitioned_items=126;
  java.util.Random r=new java.util.Random(0);
  final int iterations=isValgrind() ? 5 : 5;
  for (int ii=0; ii < iterations; ii++) {
    Client client=getClient();
    VoltTable repl_table=createReplicatedTable(num_replicated_items,0,null);
    VoltTable partition_table=createPartitionedTable(num_partitioned_items,0);
    loadTable(client,"REPLICATED_TESTER",true,repl_table);
    loadTable(client,"PARTITION_TESTER",false,partition_table);
    VoltTable results[]=saveTablesWithDefaultOptions(client);
    validateSnapshot(true);
    while (results[0].advanceRow()) {
      if (results[0].getString("RESULT").equals("FAILURE")) {
        System.out.println(results[0].getString("ERR_MSG"));
      }
      assertTrue(results[0].getString("RESULT").equals("SUCCESS"));
    }
    corruptTestFiles(r);
    validateSnapshot(false);
    releaseClient(client);
    m_config.shutDown();
    m_config.startUp();
    client=getClient();
    results=null;
    try {
      client.callProcedure("@SnapshotRestore",TMPDIR,TESTNONCE);
      fail();
    }
 catch (    ProcCallException e) {
      assertEquals(ClientResponse.OPERATIONAL_FAILURE,e.getClientResponse().getStatus());
      results=e.getClientResponse().getResults();
    }
    assertNotNull(results);
    assertNotNull(results[0]);
    boolean haveFailure=false;
    while (results[0].advanceRow()) {
      if (results[0].getString("RESULT").equals("FAILURE")) {
        haveFailure=true;
        break;
      }
    }
    assertTrue(haveFailure);
    deleteTestFiles();
    releaseClient(client);
    m_config.shutDown();
    m_config.startUp();
  }
}
