{
  long now=System.currentTimeMillis();
  ClientResponseImpl response=new ClientResponseImpl();
  try {
    response.initFromBuffer(buf);
  }
 catch (  IOException e1) {
    e1.printStackTrace();
  }
  ProcedureCallback cb=null;
  long callTime=0;
  int delta=0;
  long handle=response.getClientHandle();
synchronized (this) {
    m_lastResponseTime=now;
    if (response.getClientHandle() == PING_HANDLE) {
      m_outstandingPing=false;
      return;
    }
    CallbackBookeeping stuff=m_callbacks.remove(response.getClientHandle());
    if (stuff == null) {
      if ((handle != TOPOLOGY_HANDLE) && (handle != PROCEDURE_HANDLE)) {
        for (        ClientStatusListenerExt listener : m_listeners) {
          listener.lateProcedureResponse(response,m_hostname,m_port);
        }
      }
    }
 else {
      callTime=stuff.timestamp;
      delta=(int)(now - callTime);
      cb=stuff.callback;
      assert(cb != null);
      final byte status=response.getStatus();
      boolean abort=false;
      boolean error=false;
      if (status == ClientResponse.USER_ABORT || status == ClientResponse.GRACEFUL_FAILURE) {
        abort=true;
      }
 else       if (status != ClientResponse.SUCCESS) {
        error=true;
      }
      int clusterRoundTrip=response.getClusterRoundtrip();
      m_rateLimiter.transactionResponseReceived(now,clusterRoundTrip);
      updateStats(stuff.name,delta,clusterRoundTrip,abort,error);
    }
  }
  try {
    if (handle == TOPOLOGY_HANDLE) {
synchronized (Distributer.this) {
        VoltTable results[]=response.getResults();
        if (results != null && results.length == 1) {
          VoltTable vt=results[0];
          updateAffinityTopology(vt);
        }
      }
    }
 else     if (handle == PROCEDURE_HANDLE) {
synchronized (Distributer.this) {
        VoltTable results[]=response.getResults();
        if (results != null && results.length == 1) {
          VoltTable vt=results[0];
          updateProcedurePartitioning(vt);
        }
      }
    }
  }
 catch (  Exception e) {
    e.printStackTrace();
  }
  if (cb != null) {
    response.setClientRoundtrip(delta);
    assert(response.getHash() == null);
    try {
      cb.clientCallback(response);
    }
 catch (    Exception e) {
      uncaughtException(cb,response,e);
    }
    int callbacksToInvoke=m_callbacksToInvoke.decrementAndGet();
    assert(callbacksToInvoke >= 0);
  }
}
