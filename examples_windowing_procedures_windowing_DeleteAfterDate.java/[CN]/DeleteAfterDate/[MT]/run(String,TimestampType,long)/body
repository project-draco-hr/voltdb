{
  if (newestToDiscard == null) {
    throw new VoltAbortException("newestToDiscard shouldn't be null.");
  }
  if (maxRowsToDeletePerProc <= 0) {
    throw new VoltAbortException("maxRowsToDeletePerProc must be > 0.");
  }
  voltQueueSQL(countMatchingRows,EXPECT_SCALAR_LONG,newestToDiscard);
  long agedOutCount=voltExecuteSQL()[0].asScalarLong();
  if (agedOutCount > maxRowsToDeletePerProc) {
    voltQueueSQL(getNthOldestTimestamp,EXPECT_SCALAR,maxRowsToDeletePerProc);
    newestToDiscard=voltExecuteSQL()[0].fetchRow(0).getTimestampAsTimestamp(0);
  }
  voltQueueSQL(deleteOlderThanDate,EXPECT_SCALAR_LONG,newestToDiscard);
  long deletedCount=voltExecuteSQL(true)[0].asScalarLong();
  return deletedCount;
}
