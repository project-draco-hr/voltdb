{
  String nonce=null;
  String data=null;
synchronized (m_lock) {
    m_snapshotSites.remove(HSId);
    MiscUtils.multimapPut(m_destToSource,masterHSId,dataSinkHSId);
    m_rejoiningSites.add(HSId);
    nonce=m_nonces.get(HSId);
    if (m_snapshotSites.isEmpty()) {
      data=makeSnapshotRequest(m_destToSource);
      m_destToSource.clear();
    }
  }
  if (nonce == null) {
    throw new RuntimeException("Received an INITIATION_RESPONSE for an HSID for which no nonce exists: " + CoreUtils.hsIdToString(HSId));
  }
  if (data != null) {
    REJOINLOG.debug("Snapshot request: " + data);
    SnapshotUtil.requestSnapshot(0l,"",nonce,!m_liveRejoin,SnapshotFormat.STREAM,data,m_handler,true);
  }
}
