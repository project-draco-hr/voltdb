{
  if (_connection.isIncluding())   return;
  if (this._outputState == 0 && !isCommitted()) {
    _explicitEncoding=true;
    if (encoding == null) {
      if (_characterEncoding != null) {
        _characterEncoding=null;
        if (_cachedMimeType != null)         _connection.getResponseFields().put(HttpHeaders.CONTENT_TYPE_BUFFER,_cachedMimeType);
 else         _connection.getResponseFields().put(HttpHeaders.CONTENT_TYPE_BUFFER,_mimeType);
      }
    }
 else {
      _characterEncoding=encoding;
      if (_contentType != null) {
        int i0=_contentType.indexOf(';');
        if (i0 < 0) {
          _contentType=null;
          if (_cachedMimeType != null) {
            CachedBuffer content_type=_cachedMimeType.getAssociate(_characterEncoding);
            if (content_type != null) {
              _contentType=content_type.toString();
              _connection.getResponseFields().put(HttpHeaders.CONTENT_TYPE_BUFFER,content_type);
            }
          }
          if (_contentType == null) {
            _contentType=_mimeType + ";charset=" + QuotedStringTokenizer.quoteIfNeeded(_characterEncoding,";= ");
            _connection.getResponseFields().put(HttpHeaders.CONTENT_TYPE_BUFFER,_contentType);
          }
        }
 else {
          int i1=_contentType.indexOf("charset=",i0);
          if (i1 < 0) {
            _contentType=_contentType + ";charset=" + QuotedStringTokenizer.quoteIfNeeded(_characterEncoding,";= ");
          }
 else {
            int i8=i1 + 8;
            int i2=_contentType.indexOf(" ",i8);
            if (i2 < 0)             _contentType=_contentType.substring(0,i8) + QuotedStringTokenizer.quoteIfNeeded(_characterEncoding,";= ");
 else             _contentType=_contentType.substring(0,i8) + QuotedStringTokenizer.quoteIfNeeded(_characterEncoding,";= ") + _contentType.substring(i2);
          }
          _connection.getResponseFields().put(HttpHeaders.CONTENT_TYPE_BUFFER,_contentType);
        }
      }
    }
  }
}
