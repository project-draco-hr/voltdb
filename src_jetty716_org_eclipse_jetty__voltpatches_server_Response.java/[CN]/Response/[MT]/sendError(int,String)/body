{
  if (_connection.isIncluding())   return;
  if (isCommitted())   Log.warn("Committed before " + code + " "+ message);
  resetBuffer();
  _characterEncoding=null;
  setHeader(HttpHeaders.EXPIRES,null);
  setHeader(HttpHeaders.LAST_MODIFIED,null);
  setHeader(HttpHeaders.CACHE_CONTROL,null);
  setHeader(HttpHeaders.CONTENT_TYPE,null);
  setHeader(HttpHeaders.CONTENT_LENGTH,null);
  _outputState=NONE;
  setStatus(code,message);
  if (message == null)   message=HttpStatus.getMessage(code);
  if (code != SC_NO_CONTENT && code != SC_NOT_MODIFIED && code != SC_PARTIAL_CONTENT && code >= SC_OK) {
    Request request=_connection.getRequest();
    ErrorHandler error_handler=null;
    ContextHandler.Context context=request.getContext();
    if (context != null)     error_handler=context.getContextHandler().getErrorHandler();
    if (error_handler == null)     error_handler=_connection.getConnector().getServer().getBean(ErrorHandler.class);
    if (error_handler != null) {
      request.setAttribute(Dispatcher.ERROR_STATUS_CODE,new Integer(code));
      request.setAttribute(Dispatcher.ERROR_MESSAGE,message);
      request.setAttribute(Dispatcher.ERROR_REQUEST_URI,request.getRequestURI());
      request.setAttribute(Dispatcher.ERROR_SERVLET_NAME,request.getServletName());
      error_handler.handle(null,_connection.getRequest(),_connection.getRequest(),this);
    }
 else {
      setHeader(HttpHeaders.CACHE_CONTROL,"must-revalidate,no-cache,no-store");
      setContentType(MimeTypes.TEXT_HTML_8859_1);
      ByteArrayISO8859Writer writer=new ByteArrayISO8859Writer(2048);
      if (message != null) {
        message=StringUtil.replace(message,"&","&amp;");
        message=StringUtil.replace(message,"<","&lt;");
        message=StringUtil.replace(message,">","&gt;");
      }
      String uri=request.getRequestURI();
      if (uri != null) {
        uri=StringUtil.replace(uri,"&","&amp;");
        uri=StringUtil.replace(uri,"<","&lt;");
        uri=StringUtil.replace(uri,">","&gt;");
      }
      writer.write("<html>\n<head>\n<meta http-equiv=\"Content-Type\" content=\"text/html;charset=ISO-8859-1\"/>\n");
      writer.write("<title>Error ");
      writer.write(Integer.toString(code));
      writer.write(' ');
      if (message == null)       message=HttpStatus.getMessage(code);
      writer.write(message);
      writer.write("</title>\n</head>\n<body>\n<h2>HTTP ERROR: ");
      writer.write(Integer.toString(code));
      writer.write("</h2>\n<p>Problem accessing ");
      writer.write(uri);
      writer.write(". Reason:\n<pre>    ");
      writer.write(message);
      writer.write("</pre>");
      writer.write("</p>\n<hr /><i><small>Powered by Jetty://</small></i>");
      for (int i=0; i < 20; i++)       writer.write("\n                                                ");
      writer.write("\n</body>\n</html>\n");
      writer.flush();
      setContentLength(writer.size());
      writer.writeTo(getOutputStream());
      writer.destroy();
    }
  }
 else   if (code != SC_PARTIAL_CONTENT) {
    _connection.getRequestFields().remove(HttpHeaders.CONTENT_TYPE_BUFFER);
    _connection.getRequestFields().remove(HttpHeaders.CONTENT_LENGTH_BUFFER);
    _characterEncoding=null;
    _mimeType=null;
    _cachedMimeType=null;
  }
  complete();
}
