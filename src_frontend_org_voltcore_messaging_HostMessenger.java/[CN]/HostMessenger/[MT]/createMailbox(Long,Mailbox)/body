{
  long hsId=0;
  if (proposedHSId != null) {
    if (m_siteMailboxes.get().containsKey(proposedHSId)) {
      VoltDB.crashLocalVoltDB("Attempted to create a mailbox for site " + MiscUtils.hsIdToString(proposedHSId) + " twice",true,null);
    }
    hsId=proposedHSId;
  }
 else {
    hsId=getHostId() + (((long)m_nextSiteId.getAndIncrement()) << 32);
    mailbox.setHSId(hsId);
  }
  while (true) {
    HashMap<Long,Mailbox> original=m_siteMailboxes.get();
    HashMap<Long,Mailbox> update=new HashMap<Long,Mailbox>(original);
    update.put(hsId,mailbox);
    if (m_siteMailboxes.compareAndSet(original,update)) {
      break;
    }
  }
}
