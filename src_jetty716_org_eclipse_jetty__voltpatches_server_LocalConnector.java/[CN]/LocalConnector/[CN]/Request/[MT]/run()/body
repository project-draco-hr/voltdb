{
  ByteArrayEndPoint endPoint=new ByteArrayEndPoint(requestsBuffer.asArray(),1024){
    @Override public void setConnection(    Connection connection){
      connectionUpgraded(getConnection(),connection);
      super.setConnection(connection);
    }
  }
;
  endPoint.setGrowOutput(true);
  HttpConnection connection=new HttpConnection(LocalConnector.this,endPoint,getServer());
  endPoint.setConnection(connection);
  connectionOpened(connection);
  boolean leaveOpen=keepOpen;
  try {
    while (endPoint.getIn().length() > 0 && endPoint.isOpen()) {
      while (true) {
        final Connection con=endPoint.getConnection();
        final Connection next=con.handle();
        if (next != con) {
          endPoint.setConnection(next);
          continue;
        }
        break;
      }
    }
  }
 catch (  Exception x) {
    leaveOpen=false;
  }
 finally {
    if (!leaveOpen)     connectionClosed(connection);
    responsesBuffer=endPoint.getOut();
    if (latch != null)     latch.countDown();
  }
}
