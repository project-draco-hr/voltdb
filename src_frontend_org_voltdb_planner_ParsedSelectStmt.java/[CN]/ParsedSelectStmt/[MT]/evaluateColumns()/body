{
  Map<AbstractExpression,Integer> aggTableIndexMap=new HashMap<AbstractExpression,Integer>();
  Map<AbstractExpression,String> exprToAliasMap=new HashMap<AbstractExpression,String>();
  for (int i=0; i < aggResultColumns.size(); i++) {
    ParsedColInfo col=aggResultColumns.get(i);
    aggTableIndexMap.put(col.expression,i);
    exprToAliasMap.put(col.expression,col.alias);
  }
  newAggSchema=new NodeSchema();
  for (  ParsedColInfo col : displayColumns) {
    SchemaColumn schema_col=null;
    if (col.expression.hasAnySubexpressionOfClass(AggregateExpression.class)) {
      AbstractExpression expr=col.expression.replaceWithTVE(aggTableIndexMap,exprToAliasMap);
      schema_col=new SchemaColumn("VOLT_TEMP_TABLE","",col.alias,expr);
    }
 else {
      schema_col=new SchemaColumn(col.tableName,col.columnName,col.alias,col.expression);
    }
    newAggSchema.addColumn(schema_col);
  }
  if (!hasComplexAgg()) {
    if (displayColumns.size() == aggResultColumns.size())     for (int ii=0; ii < displayColumns.size(); ii++) {
      ParsedColInfo dcol=displayColumns.get(ii);
      Integer idx=aggTableIndexMap.get(dcol.expression);
      if ((idx != null && idx.intValue() == ii && dcol.simpleEquals(aggResultColumns.get(ii))) == false) {
        setComlexAgg(true);
        break;
      }
    }
 else {
      setComlexAgg(true);
    }
  }
  for (  ParsedColInfo col : groupByColumns) {
    if (col.expression.hasAnySubexpressionOfClass(AggregateExpression.class)) {
      AbstractExpression expr=col.expression.replaceWithTVE(aggTableIndexMap,exprToAliasMap);
      col.expression=expr;
    }
  }
  for (  ParsedColInfo col : orderColumns) {
    if (col.expression.hasAnySubexpressionOfClass(AggregateExpression.class)) {
      AbstractExpression expr=col.expression.replaceWithTVE(aggTableIndexMap,exprToAliasMap);
      col.expression=expr;
    }
  }
}
